<!DOCTYPE html>
<html>
<head>
    <title>PiFlip Nano</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #FF6600;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* Flipper-style header */
        .header {
            background: linear-gradient(180deg, #FF6600 0%, #FF8833 100%);
            color: #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(255, 102, 0, 0.5);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .status-bar {
            background: #1a1a1a;
            padding: 8px 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .status-indicator {
            display: flex;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.active { background: #0f0; }
        .status-dot.inactive { background: #f00; }
        .status-dot.warning { background: #ff0; }

        /* Breadcrumb navigation */
        .breadcrumb {
            background: #0a0a0a;
            padding: 10px 15px;
            font-size: 14px;
            color: #888;
            border-bottom: 1px solid #333;
        }

        .breadcrumb a {
            color: #FF6600;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover { text-decoration: underline; }

        /* Main menu container */
        .menu-container {
            padding: 0;
            max-width: 600px;
            margin: 0 auto;
        }

        .menu-item {
            background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 100%);
            border-bottom: 1px solid #333;
            padding: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 65px; /* Bigger touch target */
        }

        .menu-item:active {
            background: #333;
            transform: scale(0.98); /* Touch feedback */
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Mobile enhancements */
        @media (max-width: 768px) {
            .menu-item {
                padding: 24px 20px; /* Even bigger on mobile */
                min-height: 75px;
            }

            .header {
                font-size: 18px;
                padding: 18px;
            }

            .menu-icon {
                font-size: 28px !important; /* Bigger icons */
            }

            .menu-title {
                font-size: 16px !important;
            }

            .menu-subtitle {
                font-size: 13px !important;
            }
        }

        /* Touch-friendly buttons */
        .output-close, .menu-arrow {
            padding: 10px; /* Bigger tap area */
            min-width: 44px; /* iOS minimum touch target */
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .menu-item:hover {
            background: #2a2a2a;
        }

        .menu-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }

        .menu-text {
            display: flex;
            flex-direction: column;
        }

        .menu-title {
            font-size: 16px;
            font-weight: bold;
            color: #FF6600;
        }

        .menu-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }

        .menu-arrow {
            color: #666;
            font-size: 18px;
        }

        /* Output panel - Fullscreen overlay */
        .output-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            padding: 60px 30px 30px 30px; /* Extra top padding for close button */
            font-size: 16px; /* Larger font for better readability */
            line-height: 1.5; /* Better line spacing */
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            z-index: 9999;
            display: none; /* Hidden by default */
            box-sizing: border-box;
        }

        .output-panel.active {
            display: block;
        }

        .output-panel:empty::before {
            content: 'Ready...';
            color: #666;
        }

        /* Close button for output overlay */
        .output-close {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #FF6600;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            z-index: 10000;
            font-family: 'Courier New', monospace;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.5);
            min-width: 120px;
        }

        .output-close:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 102, 0, 0.5);
        }

        /* Mobile output improvements */
        @media (max-width: 768px) {
            .output-panel {
                font-size: 15px;
                padding: 70px 20px 20px 20px;
                line-height: 1.6;
            }

            .output-close {
                padding: 18px 35px;
                font-size: 16px;
                min-width: 130px;
                top: 12px;
                right: 12px;
            }
        }

        /* Loading indicator */
        .loading-dots::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Smooth scrolling for better mobile experience */
        html {
            scroll-behavior: smooth;
        }

        /* Prevent text selection on buttons (better for touch) */
        .menu-item, .output-close, button {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Haptic feedback simulation (visual) */
        @keyframes tap-feedback {
            0% { transform: scale(1); }
            50% { transform: scale(0.97); }
            100% { transform: scale(1); }
        }

        /* Scaled output styling for better visibility */
        .output-panel h1,
        .output-panel h2,
        .output-panel h3 {
            color: #FF6600;
            margin: 20px 0 10px 0;
        }

        .output-panel strong {
            color: #FF8833;
        }

        /* Better box drawing characters */
        .output-panel {
            letter-spacing: 0.05em;
        }

        /* Waterfall display */
        .waterfall-container {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .waterfall-canvas {
            width: 100%;
            flex: 1;
            background: #000;
            image-rendering: pixelated;
        }

        .waterfall-controls {
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .waterfall-info {
            background: #1a1a1a;
            padding: 10px;
            font-size: 12px;
            color: #FF6600;
            display: flex;
            justify-content: space-between;
        }

        /* Action buttons */
        .action-buttons {
            padding: 15px;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            background: linear-gradient(180deg, #FF6600 0%, #DD5500 100%);
            color: #000;
            border: none;
            padding: 15px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            box-shadow: 0 3px 10px rgba(255, 102, 0, 0.3);
        }

        .action-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 5px rgba(255, 102, 0, 0.3);
        }

        .action-btn.secondary {
            background: linear-gradient(180deg, #444 0%, #222 100%);
            color: #FF6600;
        }



        .toggle-label {
            font-size: 14px;
            font-weight: bold;
        }

        .toggle-switch {
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }

        .toggle-switch.active {
            background: #FF6600;
        }

        .toggle-slider {
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 33px;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #333;
            border-top: 2px solid #FF6600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #FF6600; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">🦊 PiFlip Nano</div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-indicator">
            <span><span class="status-dot active" id="nfc-dot"></span> NFC</span>
            <span><span class="status-dot active" id="rtl-dot"></span> RTL</span>
            <span><span class="status-dot active" id="cc1101-dot"></span> CC1101</span>
            <span id="tx-indicator" style="display: none;"><span class="status-dot" style="background: #ff0; animation: blink 0.5s infinite;"></span> TX</span>
        </div>
        <div id="battery-indicator">🔋 100%</div>
    </div>

    <!-- Breadcrumb -->
    <div class="breadcrumb" id="breadcrumb">
        <a onclick="showMainMenu()">Main Menu</a>
    </div>

    <!-- Main Menu Container -->
    <div class="menu-container" id="menu-container">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="menu-view">
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">🦊</div>
                <div style="font-size: 28px; font-weight: bold; color: #FF6600; margin-bottom: 10px;">PiFlip</div>
                <div style="font-size: 14px; color: #888; margin-bottom: 40px;">RF & NFC Multi-Tool</div>

                <!-- Hardware Status -->
                <div style="background: #1a1a1a; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #333;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #FF6600;">🔧 Hardware Status</div>
                    <div id="welcome-hw-status" style="font-size: 14px; color: #ccc; line-height: 2;">
                        <div id="welcome-cc1101">📡 CC1101: <span style="color: #888;">Checking...</span></div>
                        <div id="welcome-nfc">💳 PN532 (NFC): <span style="color: #888;">Checking...</span></div>
                        <div id="welcome-rtl">📻 RTL-SDR: <span style="color: #888;">Checking...</span></div>
                    </div>
                </div>

                <!-- Quick Start Button -->
                <div class="menu-item" onclick="showMainMenu()" style="max-width: 400px; margin: 0 auto; background: linear-gradient(90deg, #FF6600, #FF8833); border: none; min-height: 65px;">
                    <div style="width: 100%; text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: #000;">Get Started →</div>
                    </div>
                </div>

                <!-- Version Info -->
                <div style="margin-top: 40px; font-size: 11px; color: #666;">
                    Version 1.0.0 • Raspberry Pi<br>
                    Made with ❤️ for the hacker community
                </div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="main-menu" class="menu-view hidden">
            <div class="menu-item" onclick="showSubMenu('rf-tools')">
                <div class="menu-item-left">
                    <span class="menu-icon">📡</span>
                    <div class="menu-text">
                        <span class="menu-title">RF Tools (CC1101)</span>
                        <span class="menu-subtitle">Sub-GHz TX/RX</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('rtl-sdr-menu')" id="rtl-sdr-menu-item" style="display: none;">
                <div class="menu-item-left">
                    <span class="menu-icon">📻</span>
                    <div class="menu-text">
                        <span class="menu-title">RTL-SDR Tools</span>
                        <span class="menu-subtitle">Wide-band RX (optional)</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('nfc-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">💳</span>
                    <div class="menu-text">
                        <span class="menu-title">NFC Tools</span>
                        <span class="menu-subtitle">Read, Clone, Backup</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>


            <!-- NFC Guardian -->
            <div class="menu-item" onclick="showSubMenu('guardian-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">🛡️</span>
                    <div class="menu-text">
                        <span class="menu-title">NFC Guardian</span>
                        <span class="menu-subtitle">Security monitoring</span>
                    </div>
                </div>
            </div>

            <!-- Card Catalog -->
            <div class="menu-item" onclick="showSubMenu('catalog-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">📇</span>
                    <div class="menu-text">
                        <span class="menu-title">Card Catalog</span>
                        <span class="menu-subtitle">Manage your cards</span>
                    </div>
                </div>
            </div>

            <!-- Wallet Tester -->
            <div class="menu-item" onclick="showSubMenu('wallet-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">🧪</span>
                    <div class="menu-text">
                        <span class="menu-title">Wallet Tester</span>
                        <span class="menu-subtitle">Test RFID blocking</span>
                    </div>
                </div>
            </div>
            <div class="menu-item" onclick="showSubMenu('bluetooth-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">🔵</span>
                    <div class="menu-text">
                        <span class="menu-title">Bluetooth Scanner</span>
                        <span class="menu-subtitle">BLE & Classic Devices</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('wifi-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">📶</span>
                    <div class="menu-text">
                        <span class="menu-title">WiFi Tools</span>
                        <span class="menu-subtitle">Hotspot & Network Scanner</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('spectrum-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">📊</span>
                    <div class="menu-text">
                        <span class="menu-title">Spectrum Analyzer</span>
                        <span class="menu-subtitle">PortaPack-style Scan</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('library')">
                <div class="menu-item-left">
                    <span class="menu-icon">📚</span>
                    <div class="menu-text">
                        <span class="menu-title">Signal Library</span>
                        <span class="menu-subtitle">Manage Captures</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('advanced-tx-menu')">
                <div class="menu-item-left">
                    <span class="menu-icon">🚀</span>
                    <div class="menu-text">
                        <span class="menu-title">Advanced TX</span>
                        <span class="menu-subtitle">Replay, Fuzz, Brute Force</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>

            <div class="menu-item" onclick="showSubMenu('settings')">
                <div class="menu-item-left">
                    <span class="menu-icon">⚙️</span>
                    <div class="menu-text">
                        <span class="menu-title">Settings</span>
                        <span class="menu-subtitle">Hardware, Config</span>
                    </div>
                </div>
                <span class="menu-arrow">›</span>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="menu-view hidden">
            <div id="dashboard-content"></div>
        </div>

        <!-- Favorites -->
        <div id="favorites" class="menu-view hidden">
            <div id="favorites-content"></div>
        </div>

        <!-- RF Tools Submenu -->
        <div id="rf-tools" class="menu-view hidden">
            <div class="menu-item" onclick="showSignalStrength()">
                <div class="menu-item-left">
                    <span class="menu-icon">📶</span>
                    <div class="menu-text">
                        <span class="menu-title">Signal Strength Meter</span>
                        <span class="menu-subtitle">Live RSSI monitor</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="cc1101QuickTest()">
                <div class="menu-item-left">
                    <span class="menu-icon">⚡</span>
                    <div class="menu-text">
                        <span class="menu-title">Quick Signal Test</span>
                        <span class="menu-subtitle">Find best frequency</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="cc1101CaptureSignal()">
                <div class="menu-item-left">
                    <span class="menu-icon">📻</span>
                    <div class="menu-text">
                        <span class="menu-title">Capture Signal (CC1101)</span>
                        <span class="menu-subtitle">RX on any frequency</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="cc1101ScanFrequencies()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔍</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan Frequencies</span>
                        <span class="menu-subtitle">Find active signals</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="cc1101ShowLibrary()">
                <div class="menu-item-left">
                    <span class="menu-icon">📚</span>
                    <div class="menu-text">
                        <span class="menu-title">RF Signal Library</span>
                        <span class="menu-subtitle">Saved captures</span>
                    </div>
                </div>
            </div>

            <!-- Info panel for CC1101 -->
            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #FF6600;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">ℹ️ CC1101 Capabilities</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Frequency Range:</strong> 300-928 MHz<br>
                    <strong>Mode:</strong> TX + RX (transmit & receive)<br>
                    <br>
                    <strong>Common Frequencies:</strong><br>
                    • 315 MHz - US garage/car remotes<br>
                    • 433.92 MHz - EU remotes, sensors<br>
                    • 868 MHz - EU ISM band<br>
                    • 915 MHz - US ISM band
                </div>
            </div>
        </div>

        <!-- RTL-SDR Tools (Optional - only if hardware detected) -->
        <div id="rtl-sdr-menu" class="menu-view hidden">
            <div class="menu-item" onclick="showWaterfall()">
                <div class="menu-item-left">
                    <span class="menu-icon">🌊</span>
                    <div class="menu-text">
                        <span class="menu-title">Spectrum Waterfall</span>
                        <span class="menu-subtitle">Real-time display</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="scan433()">
                <div class="menu-item-left">
                    <span class="menu-icon">📡</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan 433MHz</span>
                        <span class="menu-subtitle">Find devices (30s)</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="showCaptureForm()">
                <div class="menu-item-left">
                    <span class="menu-icon">⏺️</span>
                    <div class="menu-text">
                        <span class="menu-title">Capture IQ Data</span>
                        <span class="menu-subtitle">Record raw samples</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="scanTPMS()">
                <div class="menu-item-left">
                    <span class="menu-icon">🚗</span>
                    <div class="menu-text">
                        <span class="menu-title">TPMS Sensors</span>
                        <span class="menu-subtitle">Tire pressure (45s)</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="scanWeather()">
                <div class="menu-item-left">
                    <span class="menu-icon">🌡️</span>
                    <div class="menu-text">
                        <span class="menu-title">Weather Stations</span>
                        <span class="menu-subtitle">433MHz sensors (60s)</span>
                    </div>
                </div>
            </div>

            <!-- Info panel -->
            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #FF6600;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">ℹ️ RTL-SDR Capabilities</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Frequency Range:</strong> 24 MHz - 1.7 GHz<br>
                    <strong>Mode:</strong> RX only (receive-only)<br>
                    <br>
                    <strong>Use Cases:</strong><br>
                    • Wide-band scanning<br>
                    • FM/AM radio reception<br>
                    • Aviation (ADS-B 1090MHz)<br>
                    • Weather satellites (137MHz)<br>
                    • TPMS (315/433 MHz)<br>
                    <br>
                    <strong>⚠️ Note:</strong> Cannot transmit
                </div>
            </div>
        </div>

        <!-- NFC Menu -->
        <div id="nfc-menu" class="menu-view hidden">
            <div class="menu-item" onclick="scanNFC()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔍</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan Card</span>
                        <span class="menu-subtitle">Read UID (single)</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="scanNFCContinuous()">
                <div class="menu-item-left">
                    <span class="menu-icon">📡</span>
                    <div class="menu-text">
                        <span class="menu-title">Multi-Card Scanner</span>
                        <span class="menu-subtitle">Compare multiple cards</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="backupNFC()">
                <div class="menu-item-left">
                    <span class="menu-icon">💾</span>
                    <div class="menu-text">
                        <span class="menu-title">Backup Card</span>
                        <span class="menu-subtitle">Save to JSON</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="listSavedCards()">
                <div class="menu-item-left">
                    <span class="menu-icon">📋</span>
                    <div class="menu-text">
                        <span class="menu-title">Card Library</span>
                        <span class="menu-subtitle">View saved cards</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="deepAnalyzeNewCard()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔬</span>
                    <div class="menu-text">
                        <span class="menu-title">Deep Analyze Card</span>
                        <span class="menu-subtitle">Full card inspection</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="cloneCard()">
                <div class="menu-item-left">
                    <span class="menu-icon">✨</span>
                    <div class="menu-text">
                        <span class="menu-title">Clone Card</span>
                        <span class="menu-subtitle">Read & write to magic card</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Library -->
        <div id="library" class="menu-view hidden">
            <div id="library-items"></div>
        </div>

        <!-- Bluetooth Menu -->
        <div id="bluetooth-menu" class="menu-view hidden">
            <div class="menu-item" onclick="bluetoothScan('comprehensive')">
                <div class="menu-item-left">
                    <span class="menu-icon">🔍</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan All Devices</span>
                        <span class="menu-subtitle">BLE + Classic (15s)</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="bluetoothScan('ble')">
                <div class="menu-item-left">
                    <span class="menu-icon">📱</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan BLE Only</span>
                        <span class="menu-subtitle">Bluetooth Low Energy</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="bluetoothScan('classic')">
                <div class="menu-item-left">
                    <span class="menu-icon">🎧</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan Classic Only</span>
                        <span class="menu-subtitle">Bluetooth Classic</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="bluetoothShowLibrary()">
                <div class="menu-item-left">
                    <span class="menu-icon">📚</span>
                    <div class="menu-text">
                        <span class="menu-title">Saved Devices</span>
                        <span class="menu-subtitle">Device library</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="bluetoothReset()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔄</span>
                    <div class="menu-text">
                        <span class="menu-title">Reset Bluetooth</span>
                        <span class="menu-subtitle">Fix scanning issues</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #0066FF;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">ℹ️ Bluetooth Scanner</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Built-in:</strong> Raspberry Pi BT 4.1<br>
                    <strong>BLE:</strong> Phones, watches, trackers<br>
                    <strong>Classic:</strong> Headphones, speakers<br>
                    <br>
                    Detects nearby devices and shows:<br>
                    • Device address (MAC)<br>
                    • Device name<br>
                    • Signal strength (RSSI)
                </div>
            </div>
        </div>

        <!-- WiFi Menu -->
        <div id="wifi-menu" class="menu-view hidden">
            <div class="menu-item" onclick="wifiShowStatus()">
                <div class="menu-item-left">
                    <span class="menu-icon">📶</span>
                    <div class="menu-text">
                        <span class="menu-title">WiFi Status</span>
                        <span class="menu-subtitle">Current mode & connection</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="wifiToggleHotspot()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔥</span>
                    <div class="menu-text">
                        <span class="menu-title">Toggle Hotspot Mode</span>
                        <span class="menu-subtitle">Enable/disable PiFlip-RF</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="wifiScanNetworks()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔍</span>
                    <div class="menu-text">
                        <span class="menu-title">Scan WiFi Networks</span>
                        <span class="menu-subtitle">Find nearby APs</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #00FF66;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">💡 WiFi Hotspot Mode</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>SSID:</strong> PiFlip-RF<br>
                    <strong>Password:</strong> piflip123<br>
                    <strong>IP:</strong> 10.0.0.1<br>
                    <br>
                    <strong>Access PiFlip from:</strong><br>
                    • iPad, iPhone, Android<br>
                    • Laptop, any device with WiFi<br>
                    • No external network needed!<br>
                    <br>
                    Connect to <strong>PiFlip-RF</strong>, then visit:<br>
                    <strong>http://10.0.0.1:5000</strong>
                </div>
            </div>
        </div>

        <!-- Spectrum Analyzer Menu -->
        <div id="spectrum-menu" class="menu-view hidden">
            <div class="menu-item" onclick="spectrumQuickScan()">
                <div class="menu-item-left">
                    <span class="menu-icon">⚡</span>
                    <div class="menu-text">
                        <span class="menu-title">Quick Scan</span>
                        <span class="menu-subtitle">433MHz spectrum snapshot</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="spectrumWaterfallScan()">
                <div class="menu-item-left">
                    <span class="menu-icon">🌊</span>
                    <div class="menu-text">
                        <span class="menu-title">Waterfall Display</span>
                        <span class="menu-subtitle">PortaPack-style live view</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="spectrumCustomScan()">
                <div class="menu-item-left">
                    <span class="menu-icon">🎛️</span>
                    <div class="menu-text">
                        <span class="menu-title">Custom Frequency Scan</span>
                        <span class="menu-subtitle">Choose center & span</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #FF00FF;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">📊 Spectrum Analyzer</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Hardware:</strong> RTL-SDR<br>
                    <strong>Range:</strong> 24MHz - 1.7GHz<br>
                    <br>
                    <strong>Features:</strong><br>
                    • Real-time spectrum display<br>
                    • Waterfall visualization<br>
                    • Signal detection<br>
                    • Peak finding<br>
                    <br>
                    <strong>Note:</strong> RTL-SDR must not be<br>
                    in use by dump1090 (flight mode)
                </div>
            </div>
        </div>

        <!-- Advanced TX Menu -->
        <div id="advanced-tx-menu" class="menu-view hidden">
            <div class="menu-item" onclick="txReplayVariations()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔄</span>
                    <div class="menu-text">
                        <span class="menu-title">Replay with Variations</span>
                        <span class="menu-subtitle">Try freq/timing offsets</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="txBruteForce()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔓</span>
                    <div class="menu-text">
                        <span class="menu-title">Brute Force Codes</span>
                        <span class="menu-subtitle">Cycle through all codes</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="txFuzzSignal()">
                <div class="menu-item-left">
                    <span class="menu-icon">🎲</span>
                    <div class="menu-text">
                        <span class="menu-title">Signal Fuzzing</span>
                        <span class="menu-subtitle">Random timing variations</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="txRollingCode()">
                <div class="menu-item-left">
                    <span class="menu-icon">⏱️</span>
                    <div class="menu-text">
                        <span class="menu-title">Rolling Code Helper</span>
                        <span class="menu-subtitle">Capture & quick replay</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="txCustomSignal()">
                <div class="menu-item-left">
                    <span class="menu-icon">✨</span>
                    <div class="menu-text">
                        <span class="menu-title">Custom Signal</span>
                        <span class="menu-subtitle">Generate from binary</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="txJamFrequency()">
                <div class="menu-item-left">
                    <span class="menu-icon">📡</span>
                    <div class="menu-text">
                        <span class="menu-title">Frequency Jammer</span>
                        <span class="menu-subtitle">Educational testing</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #FF6600;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">🚀 Advanced TX Features</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Hardware:</strong> CC1101 (Sub-GHz)<br>
                    <strong>Range:</strong> 300-928 MHz<br>
                    <br>
                    <strong>Features:</strong><br>
                    • Replay with freq/timing variations<br>
                    • Brute force fixed codes<br>
                    • Signal fuzzing<br>
                    • Rolling code capture/replay<br>
                    • Custom signal generation<br>
                    • Educational jamming<br>
                    <br>
                    <strong>⚠️ Use responsibly!</strong><br>
                    Only on your own devices
                </div>
            </div>
        </div>


            </div>
        </div>

        <!-- Settings -->

        <!-- NFC Guardian Menu -->
        <div id="guardian-menu" class="menu-view hidden">
            <div class="menu-item" onclick="guardianShowStatus()">
                <div class="menu-item-left">
                    <span class="menu-icon">📊</span>
                    <div class="menu-text">
                        <span class="menu-title">View Status</span>
                        <span class="menu-subtitle">Current monitoring status</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="guardianStart()">
                <div class="menu-item-left">
                    <span class="menu-icon">▶️</span>
                    <div class="menu-text">
                        <span class="menu-title">Start Monitoring</span>
                        <span class="menu-subtitle">Begin watching for scans</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="guardianStop()">
                <div class="menu-item-left">
                    <span class="menu-icon">⏹️</span>
                    <div class="menu-text">
                        <span class="menu-title">Stop Monitoring</span>
                        <span class="menu-subtitle">Pause Guardian</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="guardianShowSuspicious()">
                <div class="menu-item-left">
                    <span class="menu-icon">⚠️</span>
                    <div class="menu-text">
                        <span class="menu-title">Suspicious Events</span>
                        <span class="menu-subtitle">View threat log</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #FF6600;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">🛡️ NFC Guardian</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Monitors for:</strong><br>
                    • Rapid scan attempts (3+ in 5sec)<br>
                    • Multiple different cards quickly<br>
                    • Suspicious activity patterns<br>
                    <br>
                    <strong>Use when:</strong><br>
                    • In crowded areas<br>
                    • Concerned about skimmers<br>
                    • Testing your security<br>
                </div>
            </div>
        </div>

        <!-- Card Catalog Menu -->
        <div id="catalog-menu" class="menu-view hidden">
            <div class="menu-item" onclick="catalogShowAll()">
                <div class="menu-item-left">
                    <span class="menu-icon">📋</span>
                    <div class="menu-text">
                        <span class="menu-title">View All Cards</span>
                        <span class="menu-subtitle">See your collection</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="catalogAddCard()">
                <div class="menu-item-left">
                    <span class="menu-icon">➕</span>
                    <div class="menu-text">
                        <span class="menu-title">Add New Card</span>
                        <span class="menu-subtitle">Scan to register</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="catalogIdentify()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔍</span>
                    <div class="menu-text">
                        <span class="menu-title">Identify Card</span>
                        <span class="menu-subtitle">Scan to identify</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="catalogStats()">
                <div class="menu-item-left">
                    <span class="menu-icon">📈</span>
                    <div class="menu-text">
                        <span class="menu-title">Statistics</span>
                        <span class="menu-subtitle">Catalog overview</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #00FF00;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">📇 Card Catalog</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Track:</strong><br>
                    • All your NFC cards<br>
                    • Last seen time<br>
                    • Scan history<br>
                    <br>
                    <strong>Features:</strong><br>
                    • Mark cards as protected<br>
                    • Add notes and categories<br>
                    • Quick identification<br>
                </div>
            </div>
        </div>

        <!-- Wallet Tester Menu -->
        <div id="wallet-menu" class="menu-view hidden">
            <div class="menu-item" onclick="walletQuickTest()">
                <div class="menu-item-left">
                    <span class="menu-icon">⚡</span>
                    <div class="menu-text">
                        <span class="menu-title">Quick Test</span>
                        <span class="menu-subtitle">3-second scan test</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="walletFullTest()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔬</span>
                    <div class="menu-text">
                        <span class="menu-title">Full Effectiveness Test</span>
                        <span class="menu-subtitle">Complete analysis</span>
                    </div>
                </div>
            </div>

            <div style="padding: 20px; background: #1a1a1a; margin: 10px; border-radius: 8px; border-left: 4px solid #00FFFF;">
                <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;">🧪 RFID Wallet Tester</div>
                <div style="font-size: 12px; color: #888; line-height: 1.6;">
                    <strong>Tests:</strong><br>
                    • RFID-blocking wallets<br>
                    • Sleeves and holders<br>
                    • Blocking effectiveness %<br>
                    <br>
                    <strong>How it works:</strong><br>
                    1. Quick: Scan card in wallet<br>
                    2. Full: Baseline then protected<br>
                    3. Get blocking percentage<br>
                    <br>
                    <strong>Know if your wallet works!</strong>
                </div>
            </div>
        </div>

        <div id="settings" class="menu-view hidden">
            <div class="menu-item" onclick="checkHardware()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔧</span>
                    <div class="menu-text">
                        <span class="menu-title">Hardware Status</span>
                        <span class="menu-subtitle">Test modules</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="showInfo('Theme settings coming soon')">
                <div class="menu-item-left">
                    <span class="menu-icon">🎨</span>
                    <div class="menu-text">
                        <span class="menu-title">Theme</span>
                        <span class="menu-subtitle">Color schemes</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="systemReboot()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔄</span>
                    <div class="menu-text">
                        <span class="menu-title">Reboot</span>
                        <span class="menu-subtitle">Restart system</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" onclick="systemShutdown()">
                <div class="menu-item-left">
                    <span class="menu-icon">🔴</span>
                    <div class="menu-text">
                        <span class="menu-title">Shutdown</span>
                        <span class="menu-subtitle">Power off safely</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="output">
        <button class="output-close" onclick="closeOutput()">✕ CLOSE</button>
    </div>

    <script>
        let currentView = 'welcome-screen';
        let breadcrumbPath = [];

        // TX Indicator functions
        function showTXIndicator() {
            document.getElementById('tx-indicator').style.display = 'inline';
        }

        function hideTXIndicator() {
            document.getElementById('tx-indicator').style.display = 'none';
        }

        // Show/hide breadcrumb based on view
        function updateBreadcrumbVisibility() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (currentView === 'welcome-screen') {
                breadcrumb.style.display = 'none';
            } else {
                breadcrumb.style.display = 'block';
            }
        }

        // Show submenu
        function showSubMenu(menuId) {
            document.getElementById(currentView).classList.add('hidden');
            document.getElementById(menuId).classList.remove('hidden');
            currentView = menuId;

            const menuNames = {
                'dashboard': 'Dashboard',
                'favorites': 'Favorites',
                'rf-tools': 'RF Tools',
                'nfc-menu': 'NFC Tools',
                'library': 'Signal Library',
                'settings': 'Settings',
                'bluetooth-menu': 'Bluetooth Scanner',
                'wifi-menu': 'WiFi Tools',
                'spectrum-menu': 'Spectrum Analyzer',
                'advanced-tx-menu': 'Advanced TX',
                'guardian-menu': 'NFC Guardian',
                'catalog-menu': 'Card Catalog',
                'wallet-menu': 'Wallet Tester',
            };

            breadcrumbPath.push(menuNames[menuId]);
            updateBreadcrumb();
            updateBreadcrumbVisibility();

            // Load content if needed
            if (menuId === 'library') {
                loadLibrary();
            } else if (menuId === 'favorites') {
                loadFavorites();
            }
        }

        // Show dashboard
        async function showDashboard() {
            document.getElementById(currentView).classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            currentView = 'dashboard';

            breadcrumbPath.push('Dashboard');
            updateBreadcrumb();

            await loadDashboard();
        }

        // Load dashboard content
        async function loadDashboard() {
            const dashboardContent = document.getElementById('dashboard-content');
            dashboardContent.innerHTML = '<div style="padding: 20px; text-align: center;">📊 Loading dashboard...</div>';

            try {
                // Fetch stats and recent activity
                const [statsRes, recentRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/recent')
                ]);

                const stats = await statsRes.json();
                const recent = await recentRes.json();

                let output = '';

                // Main stats grid
                output += '<div style="padding: 12px; background: #1a1a1a; margin: 8px; border-radius: 8px; border-left: 4px solid #FF6600;">';
                output += '<div style="font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #FF6600;">📊 OVERVIEW</div>';
                output += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';

                // RF Captures
                output += `<div style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #333;">`;
                output += `<div style="font-size: 28px; color: #FF6600; font-weight: bold;">${stats.total_rf_captures || 0}</div>`;
                output += `<div style="font-size: 11px; color: #999; margin-top: 4px;">📡 RF CAPTURES</div>`;
                output += `</div>`;

                // NFC Cards
                output += `<div style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #333;">`;
                output += `<div style="font-size: 28px; color: #FF6600; font-weight: bold;">${stats.total_nfc_reads || 0}</div>`;
                output += `<div style="font-size: 11px; color: #999; margin-top: 4px;">💳 NFC CARDS</div>`;
                output += `</div>`;

                // Storage
                output += `<div style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #333;">`;
                output += `<div style="font-size: 28px; color: #FF6600; font-weight: bold;">${stats.storage_used_mb || 0}</div>`;
                output += `<div style="font-size: 11px; color: #999; margin-top: 4px;">💾 MB USED</div>`;
                output += `</div>`;

                // Total Scans
                output += `<div style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #333;">`;
                output += `<div style="font-size: 28px; color: #FF6600; font-weight: bold;">${stats.total_scans || 0}</div>`;
                output += `<div style="font-size: 11px; color: #999; margin-top: 4px;">🔍 TOTAL SCANS</div>`;
                output += `</div>`;

                output += '</div>';
                output += '</div>';

                // Top Frequencies
                if (stats.top_frequencies && Object.keys(stats.top_frequencies).length > 0) {
                    output += '<div style="padding: 12px; background: #1a1a1a; margin: 8px; border-radius: 8px; border-left: 4px solid #FF6600;">';
                    output += '<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #FF6600;">📻 TOP FREQUENCIES</div>';

                    const freqs = Object.entries(stats.top_frequencies).slice(0, 5);
                    freqs.forEach(([freq, count]) => {
                        const barWidth = (count / freqs[0][1]) * 100;
                        output += `<div style="margin-bottom: 8px;">`;
                        output += `<div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px;">`;
                        output += `<span style="color: #ccc;">${freq} MHz</span>`;
                        output += `<span style="color: #FF6600; font-weight: bold;">${count}</span>`;
                        output += `</div>`;
                        output += `<div style="background: #252525; height: 6px; border-radius: 3px; overflow: hidden;">`;
                        output += `<div style="background: linear-gradient(90deg, #FF6600, #FF8833); height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>`;
                        output += `</div>`;
                        output += `</div>`;
                    });

                    output += '</div>';
                }

                // Recent Activity Feed
                output += '<div style="padding: 12px; background: #1a1a1a; margin: 8px; border-radius: 8px; border-left: 4px solid #FF6600;">';
                output += '<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #FF6600;">📜 RECENT ACTIVITY</div>';

                if (recent && recent.length > 0) {
                    recent.slice(0, 10).forEach(item => {
                        const icon = item.type === 'rf_capture' ? '📡' : '💳';
                        const iconBg = item.type === 'rf_capture' ? '#2a1a0a' : '#1a1a2a';
                        const time = getTimeAgo(item.timestamp);

                        output += `<div style="background: #252525; padding: 10px; margin-bottom: 6px; border-radius: 6px; display: flex; align-items: center; border: 1px solid #333;">`;
                        output += `<div style="background: ${iconBg}; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 12px;">${icon}</div>`;
                        output += `<div style="flex: 1;">`;
                        output += `<div style="font-size: 13px; font-weight: bold; color: #fff;">${item.name}</div>`;

                        if (item.type === 'rf_capture') {
                            const freqMhz = item.frequency ? (item.frequency > 1000 ? (item.frequency/1e6).toFixed(2) : item.frequency.toFixed(2)) : '?';
                            output += `<div style="font-size: 11px; color: #888;">📻 ${freqMhz} MHz · ${item.duration || '?'}s · ${item.size_kb || '?'} KB</div>`;
                        } else {
                            output += `<div style="font-size: 11px; color: #888;">UID: ${item.uid || 'unknown'} · ${item.card_type || 'unknown'}</div>`;
                        }

                        output += `</div>`;
                        output += `<div style="font-size: 10px; color: #666; white-space: nowrap;">${time}</div>`;
                        output += `</div>`;
                    });
                } else {
                    output += '<div style="text-align: center; padding: 30px; color: #666;">';
                    output += '<div style="font-size: 48px; margin-bottom: 10px;">📭</div>';
                    output += '<div style="font-size: 14px;">No activity yet</div>';
                    output += '<div style="font-size: 12px; margin-top: 5px;">Start capturing signals!</div>';
                    output += '</div>';
                }

                output += '</div>';

                // Quick Actions
                output += '<div style="padding: 12px; background: #1a1a1a; margin: 8px; border-radius: 8px; border-left: 4px solid #FF6600;">';
                output += '<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #FF6600;">⚡ QUICK ACTIONS</div>';
                output += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';

                output += `<div onclick="showSubMenu('rf-tools')" style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid #333;">`;
                output += `<div style="font-size: 24px; margin-bottom: 5px;">📡</div>`;
                output += `<div style="font-size: 11px; color: #ccc;">RF TOOLS</div>`;
                output += `</div>`;

                output += `<div onclick="showSubMenu('nfc-menu')" style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid #333;">`;
                output += `<div style="font-size: 24px; margin-bottom: 5px;">💳</div>`;
                output += `<div style="font-size: 11px; color: #ccc;">NFC TOOLS</div>`;
                output += `</div>`;

                output += `<div onclick="showSubMenu('library')" style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid #333;">`;
                output += `<div style="font-size: 24px; margin-bottom: 5px;">📚</div>`;
                output += `<div style="font-size: 11px; color: #ccc;">LIBRARY</div>`;
                output += `</div>`;

                output += `<div onclick="checkHardware()" style="background: #252525; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid #333;">`;
                output += `<div style="font-size: 24px; margin-bottom: 5px;">🔧</div>`;
                output += `<div style="font-size: 11px; color: #ccc;">HARDWARE</div>`;
                output += `</div>`;

                output += '</div>';
                output += '</div>';

                dashboardContent.innerHTML = output;

            } catch (error) {
                dashboardContent.innerHTML = `<div style="padding: 20px; color: #f00;">❌ Error loading dashboard: ${error.message}</div>`;
            }
        }

        // Helper: Get time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);

            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Load favorites
        async function loadFavorites() {
            const favoritesContent = document.getElementById('favorites-content');
            favoritesContent.innerHTML = '<div style="padding: 20px; text-align: center;">⭐ Loading favorites...</div>';

            try {
                const response = await fetch('/api/favorites');
                const favorites = await response.json();

                let output = '';

                // RF Favorites
                if (favorites.rf && favorites.rf.length > 0) {
                    output += '<div style="padding: 15px; background: #1a1a1a; margin: 10px; border-radius: 8px;">';
                    output += '<div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">📡 RF FAVORITES</div>';

                    favorites.rf.forEach((fav, idx) => {
                        const freq = fav.metadata?.frequency || '???';
                        output += `<div class="menu-item" onclick="quickReplayRF('${fav.name}')">`;
                        output += `<div class="menu-item-left">`;
                        output += `<span class="menu-icon">⚡</span>`;
                        output += `<div class="menu-text">`;
                        output += `<span class="menu-title">${fav.name}</span>`;
                        output += `<span class="menu-subtitle">${freq} MHz</span>`;
                        output += `</div></div>`;
                        output += `<span class="menu-arrow">▶️</span>`;
                        output += `</div>`;
                    });

                    output += '</div>';
                }

                // NFC Favorites
                if (favorites.nfc && favorites.nfc.length > 0) {
                    output += '<div style="padding: 15px; background: #1a1a1a; margin: 10px; border-radius: 8px;">';
                    output += '<div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">💳 NFC FAVORITES</div>';

                    favorites.nfc.forEach((fav, idx) => {
                        const uid = fav.metadata?.uid || 'Unknown';
                        output += `<div class="menu-item" onclick="quickViewNFC('${fav.name}')">`;
                        output += `<div class="menu-item-left">`;
                        output += `<span class="menu-icon">💳</span>`;
                        output += `<div class="menu-text">`;
                        output += `<span class="menu-title">${fav.name}</span>`;
                        output += `<span class="menu-subtitle">UID: ${uid}</span>`;
                        output += `</div></div>`;
                        output += `<span class="menu-arrow">📋</span>`;
                        output += `</div>`;
                    });

                    output += '</div>';
                }

                if (output === '') {
                    output = '<div style="padding: 20px; text-align: center; color: #888;">⭐ No favorites yet!<br><br>Add favorites from RF or NFC libraries.</div>';
                }

                favoritesContent.innerHTML = output;

            } catch (error) {
                favoritesContent.innerHTML = `<div style="padding: 20px; color: #f00;">❌ Error: ${error.message}</div>`;
            }
        }

        // Quick replay from favorites
        async function quickReplayRF(name) {
            if (confirm(`⚡ Quick Replay: ${name}\n\nTransmit signal now?`)) {
                await cc1101ReplaySignal(name);

                // Log activity
                try {
                    await fetch('/api/activity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'replay',
                            type: 'rf',
                            name: name,
                            result: 'success'
                        })
                    });
                } catch (e) {}
            }
        }

        // Quick view NFC from favorites
        function quickViewNFC(name) {
            showOutput(`💳 ${name}\n\nGo to NFC Tools to scan or clone this card.`);
        }

        // Back to main menu
        function showMainMenu() {
            document.getElementById(currentView).classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            currentView = 'main-menu';
            breadcrumbPath = ['Main Menu'];
            updateBreadcrumb();
            updateBreadcrumbVisibility();
        }

        // Update breadcrumb
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = breadcrumbPath.map((item, index) => {
                if (index === breadcrumbPath.length - 1) {
                    return item;
                }
                return `<a onclick="navigateToBreadcrumb(${index})">${item}</a>`;
            }).join(' › ');
        }

        // Navigate via breadcrumb
        function navigateToBreadcrumb(index) {
            if (index === 0) {
                showMainMenu();
            }
        }

        // Output functions
        function showOutput(text) {
            const outputPanel = document.getElementById('output');

            // Set text (preserve close button)
            const closeBtn = outputPanel.querySelector('.output-close');
            outputPanel.textContent = text;
            outputPanel.appendChild(closeBtn);

            // Show overlay
            outputPanel.classList.add('active');
        }

        function appendOutput(text) {
            const outputPanel = document.getElementById('output');
            const closeBtn = outputPanel.querySelector('.output-close');
            const currentText = outputPanel.textContent.replace('✕ CLOSE', '').trim();

            outputPanel.textContent = currentText + '\n' + text;
            outputPanel.appendChild(closeBtn);
        }

        function showInfo(text) {
            showOutput('ℹ️ ' + text);
        }

        function closeOutput() {
            // Clear any running scan intervals
            if (window.nfcScanIntervals) {
                clearInterval(window.nfcScanIntervals.animationInterval);
                clearInterval(window.nfcScanIntervals.scanInterval);
                window.nfcScanIntervals = null;
            }

            // Clear RSSI monitor interval
            if (rssiMonitorInterval) {
                clearInterval(rssiMonitorInterval);
                rssiMonitorInterval = null;
            }

            document.getElementById('output').classList.remove('active');
        }

        // RF Functions
        async function scan433() {
            showOutput('📡 Scanning 433MHz for 30 seconds...\nPress devices now!');
            try {
                const response = await fetch('/api/scan433');
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        function showCaptureForm() {
            const name = prompt('Signal name:', 'capture_' + Date.now());
            if (!name) return;

            const freq = prompt('Frequency (MHz):', '433.92');
            const duration = prompt('Duration (seconds):', '5');

            captureSignal(name, parseFloat(freq) * 1e6, parseInt(duration));
        }

        async function captureSignal(name, frequency, duration) {
            showOutput(`⏺️ Capturing "${name}" at ${frequency/1e6}MHz for ${duration}s...\n\nPress device NOW!`);

            try {
                const response = await fetch('/api/capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, frequency, duration, sample_rate: 2048000 })
                });
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function scanTPMS() {
            showOutput('🚗 Scanning TPMS for 45 seconds...\nRoll car back/forth!');
            try {
                const response = await fetch('/api/tpms');
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function scanWeather() {
            showOutput('🌡️ Scanning weather stations for 60 seconds...');
            try {
                const response = await fetch('/api/weather');
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // NFC Functions
        async function scanNFC() {
            // Show scanning animation
            let scanTime = 0;
            const maxWait = 5; // 5 seconds max wait

            const animationInterval = setInterval(() => {
                scanTime += 0.2;
                const wave = Math.floor(scanTime * 5) % 4;
                const waves = ['◐', '◓', '◑', '◒'];

                let output = '╔════════════════════════════════════════════════════╗\n';
                output += '║              💳 NFC SCANNER                        ║\n';
                output += '╚════════════════════════════════════════════════════╝\n\n';
                output += '⚡ WAITING FOR CARD ⚡\n\n';
                output += `   ${waves[wave]} Scanning NFC Field ${waves[wave]}\n\n`;
                output += 'Place card on reader...\n';
                output += `Time: ${scanTime.toFixed(1)}s / ${maxWait}s\n`;

                showOutput(output);

                if (scanTime >= maxWait) {
                    clearInterval(animationInterval);
                }
            }, 200);

            try {
                const response = await fetch('/api/nfc');
                const data = await response.json();

                clearInterval(animationInterval);

                if (data.card_present === true) {
                    let output = '╔══════════════════════════════════════════════════╗\n';
                    output += '║            ✅ NFC CARD DETECTED!                 ║\n';
                    output += '╚══════════════════════════════════════════════════╝\n\n';
                    output += 'UID:          ' + data.uid_readable + '\n';
                    output += 'Type:         ' + (data.likely_type || data.type) + '\n';
                    output += 'Manufacturer: ' + data.manufacturer + '\n';
                    output += 'Memory:       ' + data.memory + '\n';
                    output += 'Technology:   ' + data.technology + '\n';
                    output += 'Encryption:   ' + data.encryption + '\n';
                    if (data.block0) {
                        output += '\nBlock 0 Data: ' + data.block0.data + '\n';
                        output += 'Key Used:     ' + data.block0.key_used + '\n';
                    }
                    showOutput(output);
                } else {
                    showOutput('❌ No card found\n\nPlace card on reader and try again');
                }
            } catch (error) {
                clearInterval(animationInterval);
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function backupNFC() {
            showOutput(`╔══════════════════════════════════════════════════╗
║            💾 BACKUP CARD                        ║
╚══════════════════════════════════════════════════╝

Place card on reader and keep it there...
Reading will take 3 seconds...`);

            await new Promise(resolve => setTimeout(resolve, 500));

            const name = prompt('Enter a name for this card (e.g., "rewards_card", "office_badge"):');
            if (!name) {
                showOutput('❌ Backup cancelled');
                return;
            }

            showOutput(`💾 Reading card...

⚠️  IMPORTANT: Keep card on reader for 3 seconds!
Do not move the card until you see "Success" or "Error"

Scanning as "${name}"...`);

            try {
                const response = await fetch('/api/nfc/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showOutput(`✅ Card saved successfully!

📛 Name:     ${name}
🔑 UID:      ${data.uid_readable || data.uid || 'Unknown'}
📇 Type:     ${data.likely_type || data.type || 'Unknown'}

Card saved to library!
Use "Card Library" to view, clone, or analyze.`);
                } else {
                    showOutput('❌ Error: ' + (data.message || JSON.stringify(data)));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function listSavedCards() {
            const outputPanel = document.getElementById('output');
            outputPanel.innerHTML = '<div style="padding: 20px; text-align: center;">💳 Loading saved cards...</div>';
            outputPanel.classList.add('active');

            try {
                const response = await fetch('/api/nfc/library');
                const data = await response.json();

                if (data.cards && data.cards.length > 0) {
                    let html = '';

                    // Header
                    html += '<div style="padding: 20px; background: #1a1a1a; border-bottom: 2px solid #FF6600;">';
                    html += '<div style="font-size: 24px; font-weight: bold; color: #FF6600;">💳 NFC Card Library</div>';
                    html += `<div style="font-size: 14px; color: #888; margin-top: 5px;">${data.count} saved cards</div>`;
                    html += '</div>';

                    // Cards list
                    html += '<div style="padding: 15px;">';

                    data.cards.forEach((card, i) => {
                        const timeAgo = getTimeAgo(card.saved_at);

                        html += '<div style="background: #1a1a1a; margin-bottom: 12px; border-radius: 8px; border: 1px solid #333; overflow: hidden;">';

                        // Card info
                        html += '<div style="padding: 15px;">';
                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 8px;">💳 ${card.saved_name}</div>`;
                        html += `<div style="font-size: 13px; color: #888; margin-bottom: 4px;">🔑 UID: ${card.uid_readable}</div>`;
                        html += `<div style="font-size: 13px; color: #888; margin-bottom: 4px;">📇 ${card.likely_type || card.type}</div>`;
                        html += `<div style="font-size: 12px; color: #666;">🕒 ${timeAgo}</div>`;
                        html += '</div>';

                        // Action buttons - 4 columns
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1px; background: #000;">';

                        // Emulate button (for portable use)
                        html += `<div onclick="emulateCard('${card.saved_name}')" style="background: #2a2a2a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 16px; margin-bottom: 2px;">📡</div>';
                        html += '<div style="font-size: 10px; color: #0f0;">EMULATE</div>';
                        html += '</div>';

                        // Clone TO this card button
                        html += `<div onclick="cloneFromLibrary('${card.saved_name}')" style="background: #2a2a2a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 16px; margin-bottom: 2px;">✨</div>';
                        html += '<div style="font-size: 10px; color: #0ff;">CLONE</div>';
                        html += '</div>';

                        // View/Analyze button
                        html += `<div onclick="analyzeCard('${card.saved_name}')" style="background: #2a2a2a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 16px; margin-bottom: 2px;">🔍</div>';
                        html += '<div style="font-size: 10px; color: #ff0;">INFO</div>';
                        html += '</div>';

                        // Delete button
                        html += `<div onclick="confirmDeleteCard('${card.saved_name}')" style="background: #2a2a2a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 16px; margin-bottom: 2px;">🗑️</div>';
                        html += '<div style="font-size: 10px; color: #f00;">DELETE</div>';
                        html += '</div>';

                        html += '</div>';
                        html += '</div>';
                    });

                    html += '</div>';

                    // Footer tip
                    html += '<div style="padding: 15px; background: #0a0a0a; border-top: 1px solid #333; font-size: 12px; color: #666; text-align: center;">';
                    html += '💡 EMULATE for portable backup • CLONE to write to magic card';
                    html += '</div>';

                    outputPanel.innerHTML = html;

                } else {
                    outputPanel.innerHTML = '<div style="padding: 40px; text-align: center;">';
                    outputPanel.innerHTML += '<div style="font-size: 48px; margin-bottom: 15px;">💳</div>';
                    outputPanel.innerHTML += '<div style="font-size: 18px; color: #ccc; margin-bottom: 10px;">No Saved Cards</div>';
                    outputPanel.innerHTML += '<div style="font-size: 14px; color: #666;">Use "Backup Card" to save cards<br>to your library</div>';
                    outputPanel.innerHTML += '</div>';
                }

                // Add close button
                const closeBtn = document.createElement('div');
                closeBtn.className = 'output-close';
                closeBtn.textContent = '✕ CLOSE';
                closeBtn.onclick = closeOutput;
                outputPanel.appendChild(closeBtn);

            } catch (error) {
                outputPanel.innerHTML = `<div style="padding: 20px; color: #f00;">❌ Error: ${error.message}</div>`;
                const closeBtn = document.createElement('div');
                closeBtn.className = 'output-close';
                closeBtn.textContent = '✕ CLOSE';
                closeBtn.onclick = closeOutput;
                outputPanel.appendChild(closeBtn);
            }
        }

        function confirmDeleteCard(name) {
            if (confirm(`🗑️ Delete Card?\n\n"${name}"\n\nThis cannot be undone!`)) {
                deleteCard(name);
            }
        }

        async function deleteCard(cardName) {
            if (!confirm('Delete card "' + cardName + '"?')) {
                return;
            }

            showOutput('🗑️ Deleting ' + cardName + '...');
            try {
                const response = await fetch('/api/nfc/library/' + cardName, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showOutput('✅ Card deleted!\n\n' + data.message);
                    // Refresh library view
                    listSavedCards();
                } else {
                    showOutput('❌ Error: ' + (data.message || JSON.stringify(data)));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function cloneFromLibrary(cardName) {
            showOutput(`╔══════════════════════════════════════════════════╗
║       ✨ CLONE TO MAGIC CARD                     ║
╚══════════════════════════════════════════════════╝

Loading saved card: ${cardName}

This will write the UID and data from "${cardName}"
to a magic card (blue or white).

Place MAGIC card on reader now...`);

            try {
                // Load the saved card data from library
                const libResponse = await fetch('/api/nfc/library');
                const libData = await libResponse.json();

                const savedCard = libData.cards.find(c => c.saved_name === cardName);
                if (!savedCard) {
                    showOutput('❌ Error: Card "' + cardName + '" not found in library');
                    return;
                }

                // Prepare the dump data for cloning
                const dumpData = {
                    uid: savedCard.uid,
                    uid_readable: savedCard.uid_readable,
                    sectors: {} // Magic cards only need UID for basic cloning
                };

                if (!confirm(`Ready to write to magic card?\n\nThis will change the magic card's UID to:\n${savedCard.uid_readable}\n\nContinue?`)) {
                    showOutput('❌ Clone cancelled');
                    return;
                }

                showOutput('⚙️ Writing to magic card...\nDO NOT remove the card!');

                // Write to magic card
                const writeResponse = await fetch('/api/nfc/clone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dump: dumpData })
                });
                const writeResult = await writeResponse.json();

                if (writeResult.error) {
                    showOutput('❌ Error writing to magic card:\n' + writeResult.error);
                    return;
                }

                showOutput(`╔══════════════════════════════════════════════════╗
║          🎉 CLONE SUCCESSFUL! 🎉                 ║
╚══════════════════════════════════════════════════╝

Source:     ${cardName}
UID:        ${savedCard.uid_readable}
Type:       ${savedCard.likely_type || savedCard.type}

Your magic card now has the same UID as "${cardName}"!

💡 Tip: Scan the magic card to verify the UID matches.`);

            } catch (error) {
                showOutput('❌ Clone failed:\n' + error.message);
            }
        }

        async function analyzeCard(cardName) {
            showOutput(`🔍 Loading card data: ${cardName}...`);

            try {
                const response = await fetch('/api/nfc/library');
                const data = await response.json();

                const card = data.cards.find(c => c.saved_name === cardName);
                if (!card) {
                    showOutput('❌ Card not found');
                    return;
                }

                let output = '╔══════════════════════════════════════════════════╗\n';
                output += '║           🔍 CARD ANALYSIS                       ║\n';
                output += '╚══════════════════════════════════════════════════╝\n\n';

                output += `📛 NAME:         ${card.saved_name}\n`;
                output += `🔑 UID:          ${card.uid_readable}\n`;
                output += `📇 TYPE:         ${card.likely_type || card.type}\n`;
                output += `🏭 MANUFACTURER: ${card.manufacturer}\n`;
                output += `📊 TECHNOLOGY:   ${card.technology}\n`;
                output += `💾 MEMORY:       ${card.memory}\n`;
                output += `✏️  WRITABLE:     ${card.writable ? 'Yes' : 'No'}\n`;
                output += `🔐 ENCRYPTION:   ${card.encryption}\n`;
                output += `🕒 DETECTED:     ${new Date(card.detected_at).toLocaleString()}\n\n`;

                output += '─────────────────────────────────────────────────\n';
                output += '📋 UID BREAKDOWN:\n\n';

                const uidBytes = card.uid_readable.split(':');
                uidBytes.forEach((byte, idx) => {
                    output += `  Byte ${idx}: 0x${byte} (${parseInt(byte, 16)})\n`;
                });

                output += '\n─────────────────────────────────────────────────\n';
                output += '💡 CARD USAGE:\n\n';

                if (card.likely_type?.includes('MIFARE Classic')) {
                    output += '• Common in: Access badges, hotel keys\n';
                    output += '• Security: CRYPTO1 (48-bit, known vulnerabilities)\n';
                    output += '• Cloneable: Yes, to magic cards\n';
                } else if (card.likely_type?.includes('Ultralight')) {
                    output += '• Common in: Public transit, loyalty cards\n';
                    output += '• Security: Minimal/None\n';
                    output += '• Cloneable: Yes, very easy\n';
                } else {
                    output += '• Type: Unknown/Mixed\n';
                    output += '• Requires further analysis\n';
                }

                showOutput(output);

            } catch (error) {
                showOutput('❌ Error analyzing card: ' + error.message);
            }
        }

        async function deepAnalyzeNewCard() {
            showOutput(`╔══════════════════════════════════════════════════╗
║         🔬 DEEP CARD ANALYSIS                    ║
╚══════════════════════════════════════════════════╝

Perfect for rewards cards, loyalty cards, and
unknown NFC cards!

Place card on reader now...`);

            try {
                // Read full card dump
                const readResponse = await fetch('/api/nfc/read_full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const cardData = await readResponse.json();

                if (cardData.error) {
                    showOutput('❌ Error reading card:\n' + cardData.error);
                    return;
                }

                // Build detailed analysis
                let output = '╔══════════════════════════════════════════════════╗\n';
                output += '║         🔬 DEEP ANALYSIS RESULTS                 ║\n';
                output += '╚══════════════════════════════════════════════════╝\n\n';

                output += '📊 BASIC INFO:\n';
                output += `🔑 UID:          ${cardData.uid}\n`;
                output += `📏 UID Length:   ${cardData.uid.length / 2} bytes\n`;
                output += `📇 Card Type:    ${cardData.card_type || 'Unknown'}\n\n`;

                output += '─────────────────────────────────────────────────\n';
                output += '💾 MEMORY ANALYSIS:\n\n';

                if (cardData.sectors) {
                    const sectorCount = Object.keys(cardData.sectors).length;
                    output += `Total Sectors:   ${sectorCount}\n`;
                    output += `Readable:        ${sectorCount} sectors\n\n`;

                    output += '📋 Sector Overview:\n';
                    Object.keys(cardData.sectors).slice(0, 5).forEach(sector => {
                        const blocks = cardData.sectors[sector];
                        output += `\n  Sector ${sector}:\n`;
                        blocks.forEach((block, idx) => {
                            if (block && block.length > 0) {
                                // Convert block to string if it's an array
                                const blockStr = Array.isArray(block)
                                    ? block.map(b => b.toString(16).padStart(2, '0')).join('')
                                    : String(block);
                                output += `    Block ${idx}: ${blockStr.substring(0, 32)}${blockStr.length > 32 ? '...' : ''}\n`;
                            }
                        });
                    });

                    if (Object.keys(cardData.sectors).length > 5) {
                        output += `\n  ... and ${Object.keys(cardData.sectors).length - 5} more sectors\n`;
                    }
                } else {
                    output += 'No sector data available (may be encrypted)\n';
                }

                output += '\n─────────────────────────────────────────────────\n';
                output += '🔐 SECURITY ANALYSIS:\n\n';

                if (cardData.card_type?.includes('MIFARE Classic')) {
                    output += '• Encryption: CRYPTO1 (48-bit keys)\n';
                    output += '• Security Level: LOW (known vulnerabilities)\n';
                    output += '• Clone Difficulty: EASY with magic cards\n';
                    output += '• Common Uses: Access badges, hotel keys\n';
                } else if (cardData.card_type?.includes('Ultralight')) {
                    output += '• Encryption: None or minimal\n';
                    output += '• Security Level: VERY LOW\n';
                    output += '• Clone Difficulty: TRIVIAL\n';
                    output += '• Common Uses: Transit cards, loyalty programs\n';
                } else if (cardData.card_type?.includes('DESFire')) {
                    output += '• Encryption: 3DES or AES\n';
                    output += '• Security Level: HIGH\n';
                    output += '• Clone Difficulty: VERY HARD\n';
                    output += '• Common Uses: Secure access, payment cards\n';
                } else {
                    output += '• Encryption: Unknown\n';
                    output += '• Security Level: Cannot determine\n';
                    output += '• Clone Difficulty: Unknown\n';
                }

                output += '\n─────────────────────────────────────────────────\n';
                output += '💡 RECOMMENDATIONS:\n\n';

                if (cardData.card_type?.includes('MIFARE Classic')) {
                    output += '✓ This card can be cloned to magic cards\n';
                    output += '✓ Use "Clone Card" feature in NFC Tools\n';
                    output += '✓ Works for: Gym badges, hotel keys, older access systems\n';
                } else if (cardData.card_type?.includes('Ultralight')) {
                    output += '✓ Very easy to clone - minimal security\n';
                    output += '✓ Common in rewards/loyalty programs\n';
                    output += '✓ Can backup and restore UID to magic cards\n';
                } else {
                    output += '⚠️  Unknown or secured card type\n';
                    output += '⚠️  May not be clonable without keys\n';
                    output += '⚠️  Use "Backup Card" to save UID for reference\n';
                }

                output += '\n─────────────────────────────────────────────────\n\n';
                output += 'Would you like to save this card to library?\n';
                output += '(Go to "Backup Card" to save)';

                showOutput(output);

            } catch (error) {
                showOutput('❌ Analysis failed:\n' + error.message);
            }
        }

        async function emulateCard(cardName) {
            showOutput(`╔══════════════════════════════════════════════════╗
║         📡 PORTABLE CARD EMULATION               ║
╚══════════════════════════════════════════════════╝

Card: ${cardName}

Loading emulation options...`);

            try {
                const response = await fetch(`/api/nfc/emulate/${cardName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();

                if (data.error) {
                    showOutput('❌ Error: ' + data.error);
                    return;
                }

                // Build output explaining portable options
                let output = '╔══════════════════════════════════════════════════╗\n';
                output += '║      📡 PORTABLE EMULATION GUIDE                 ║\n';
                output += '╚══════════════════════════════════════════════════╝\n\n';

                output += `📛 Card: ${cardName}\n\n`;

                output += '─────────────────────────────────────────────────\n';
                output += '🎯 PORTABLE USE OPTIONS:\n\n';

                output += '📱 OPTION 1: Magic Card Backup (RECOMMENDED)\n';
                output += '────────────────────────────────────────────────\n';
                output += '1. Tap "CLONE" button for this card\n';
                output += '2. Place magic card (blue/white) on reader\n';
                output += '3. Carry magic card as backup - works like original!\n';
                output += '4. If you lose hotel key, just use magic card\n\n';

                output += '✅ PROS:\n';
                output += '  • No Pi needed once cloned\n';
                output += '  • Magic card works at ANY reader\n';
                output += '  • Pocket-sized, convenient\n';
                output += '  • Instant tap-to-use\n\n';

                output += '💡 BEST FOR: Hotel keys, gym badges, office access\n\n';

                output += '─────────────────────────────────────────────────\n';
                output += '🔧 OPTION 2: Pi + Phone (Advanced)\n';
                output += '────────────────────────────────────────────────\n';
                output += '1. Save this card to library (already done ✓)\n';
                output += '2. Make Pi portable with battery + WiFi hotspot\n';
                output += '3. Access Pi from phone browser anywhere\n';
                output += '4. When needed: Clone to magic card on-the-go\n\n';

                output += '✅ PROS:\n';
                output += '  • Store unlimited cards in library\n';
                output += '  • Clone any card anytime\n';
                output += '  • Full PiFlip functionality portable\n\n';

                output += '⚠️  CONS:\n';
                output += '  • Need to carry Pi + battery\n';
                output += '  • Still need magic card for final step\n\n';

                output += '─────────────────────────────────────────────────\n';
                output += '🚫 OPTION 3: Direct Pi Emulation (NOT SUPPORTED)\n';
                output += '────────────────────────────────────────────────\n';
                output += 'PN532 cannot emulate MIFARE Classic cards due to:\n';
                output += '  • Hardware crypto requirements (CRYPTO1)\n';
                output += '  • Firmware limitations\n';
                output += '  • Anti-cloning protections\n\n';

                output += 'You CANNOT tap Pi directly to reader like a card.\n\n';

                output += '─────────────────────────────────────────────────\n';
                output += '💡 RECOMMENDED WORKFLOW:\n\n';

                output += '🏨 HOTEL CHECK-IN:\n';
                output += '1. Get hotel key at front desk\n';
                output += '2. Go to room, open PiFlip on phone\n';
                output += '3. NFC Tools → Backup Card → Scan hotel key\n';
                output += '4. NFC Tools → Card Library → Tap CLONE\n';
                output += '5. Place magic card on Pi → Confirm\n';
                output += '6. Put magic card in wallet as backup\n';
                output += '7. Use hotel key normally\n';
                output += '8. If you lose hotel key → Use magic card!\n\n';

                output += '✨ Your magic card IS the portable solution!\n';
                output += '   No need to carry Pi once cloned.\n\n';

                output += '─────────────────────────────────────────────────\n';
                output += 'Ready to clone this card to magic card now?\n';
                output += 'Tap "CLONE" button to begin!';

                showOutput(output);

            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function cloneCard() {
            showOutput('╔══════════════════════════════════════════════════╗\n' +
                       '║            ✨ CARD CLONING WIZARD                ║\n' +
                       '╚══════════════════════════════════════════════════╝\n\n' +
                       'Perfect for hotel key cards!\n\n' +
                       'Step 1: Reading source card...\n' +
                       'Place SOURCE card (hotel key) on reader...');

            try {
                // Step 1: Read full dump from source card
                const readResponse = await fetch('/api/nfc/read_full', { method: 'POST' });
                const sourceDump = await readResponse.json();

                if (sourceDump.error) {
                    showOutput('❌ Error reading source card:\n' + sourceDump.error);
                    return;
                }

                const sectorsRead = Object.keys(sourceDump.sectors).length;
                const totalSectors = 16;
                const successRate = (sectorsRead / totalSectors * 100).toFixed(1);

                showOutput('✅ Source card read successfully!\n\n' +
                           'UID:     ' + sourceDump.uid + '\n' +
                           'Sectors: ' + sectorsRead + '/' + totalSectors + ' (' + successRate + '%)\n\n' +
                           '─────────────────────────────────────────────────\n\n' +
                           'Step 2: Writing to magic card...\n' +
                           'Remove source card.\n' +
                           'Place MAGIC card (white/blue) on reader...\n\n' +
                           'Click OK when ready...');

                await new Promise(resolve => {
                    const checkReady = setInterval(() => {
                        if (confirm('Magic card on reader? Click OK to write, Cancel to abort.')) {
                            clearInterval(checkReady);
                            resolve();
                        }
                    }, 100);
                });

                showOutput('⚙️ Writing to magic card...\n' +
                           'This may take 30-60 seconds...\n' +
                           'DO NOT remove the card!');

                // Step 2: Write to magic card
                const writeResponse = await fetch('/api/nfc/clone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dump: sourceDump })
                });
                const writeResult = await writeResponse.json();

                if (writeResult.error) {
                    showOutput('❌ Error writing to magic card:\n' + writeResult.error);
                    return;
                }

                const writeSuccessRate = (writeResult.sectors_written / writeResult.total_sectors * 100).toFixed(1);

                showOutput('✅ Write complete!\n\n' +
                           'Sectors written: ' + writeResult.sectors_written + '/' + writeResult.total_sectors +
                           ' (' + writeSuccessRate + '%)\n\n' +
                           '─────────────────────────────────────────────────\n\n' +
                           'Step 3: Verifying clone...\n' +
                           'Keep magic card on reader...');

                // Step 3: Verify
                const verifyResponse = await fetch('/api/nfc/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dump: sourceDump })
                });
                const verifyResult = await verifyResponse.json();

                if (verifyResult.error) {
                    showOutput('⚠️  Could not verify:\n' + verifyResult.error +
                               '\n\nBut write completed. Try using the card!');
                    return;
                }

                if (verifyResult.verified) {
                    showOutput('╔══════════════════════════════════════════════════╗\n' +
                               '║          🎉 CLONE SUCCESSFUL! 🎉                 ║\n' +
                               '╚══════════════════════════════════════════════════╝\n\n' +
                               'UID Match:     ' + (verifyResult.uid_match ? '✅ YES' : '❌ NO') + '\n' +
                               'Sectors Match: ' + verifyResult.sectors_match + '/' + verifyResult.sectors_total + '\n\n' +
                               'Your magic card is now a clone of the source card!\n' +
                               'Test it on your hotel room door! 🏨');
                } else {
                    showOutput('⚠️  Clone verification incomplete\n\n' +
                               'UID Match:     ' + (verifyResult.uid_match ? '✅ YES' : '❌ NO') + '\n' +
                               'Sectors Match: ' + verifyResult.sectors_match + '/' + verifyResult.sectors_total + '\n\n' +
                               'The card was written but may not be perfect.\n' +
                               'Try using it - it might still work!');
                }

            } catch (error) {
                showOutput('❌ Clone failed:\n' + error.message);
            }
        }

        // Library Functions
        async function loadLibrary() {
            const outputPanel = document.getElementById('output');
            outputPanel.innerHTML = '<div style="padding: 20px; text-align: center;">📚 Loading captures...</div>';
            outputPanel.classList.add('active');

            try {
                const response = await fetch('/api/captures');
                const data = await response.json();

                if (data.captures && data.captures.length > 0) {
                    let html = '';

                    // Header
                    html += '<div style="padding: 20px; background: #1a1a1a; border-bottom: 2px solid #FF6600;">';
                    html += '<div style="font-size: 24px; font-weight: bold; color: #FF6600;">📡 RTL-SDR Captures</div>';
                    html += `<div style="font-size: 14px; color: #888; margin-top: 5px;">${data.captures.length} saved captures</div>`;
                    html += '</div>';

                    // Captures list
                    html += '<div style="padding: 15px;">';

                    data.captures.forEach((cap, i) => {
                        const freqMhz = (cap.frequency / 1e6).toFixed(2);
                        const sizeMb = (cap.file_size / 1024 / 1024).toFixed(1);

                        html += '<div style="background: #1a1a1a; margin-bottom: 12px; border-radius: 8px; border: 1px solid #333; overflow: hidden;">';

                        // Capture info
                        html += '<div style="padding: 15px;">';
                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 8px;">📻 ${cap.name}</div>`;
                        html += `<div style="font-size: 13px; color: #888; margin-bottom: 4px;">🔊 ${freqMhz} MHz • ⏱️ ${cap.duration}s • 💾 ${sizeMb} MB</div>`;
                        html += `<div style="font-size: 12px; color: #666;">📁 Raw IQ samples (.cu8)</div>`;
                        html += '</div>';

                        // Action buttons - Row 1
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #000;">';

                        // Replay button
                        html += `<div onclick="replaySignal('${cap.name}')" style="background: #2a2a2a; padding: 15px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 18px; margin-bottom: 3px;">▶️</div>';
                        html += '<div style="font-size: 11px; color: #0f0;">REPLAY</div>';
                        html += '</div>';

                        // Analyze button
                        html += `<div onclick="analyzeSignal('${cap.name}')" style="background: #2a2a2a; padding: 15px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 18px; margin-bottom: 3px;">🔍</div>';
                        html += '<div style="font-size: 11px; color: #ff0;">ANALYZE</div>';
                        html += '</div>';

                        // Visualize button
                        html += `<div onclick="visualizeSignal('${cap.name}')" style="background: #2a2a2a; padding: 15px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 18px; margin-bottom: 3px;">📊</div>';
                        html += '<div style="font-size: 11px; color: #0ff;">VISUALIZE</div>';
                        html += '</div>';

                        html += '</div>';

                        // Action buttons - Row 2 (Advanced TX)
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #000;">';

                        // Replay with Variations
                        html += `<div onclick="txReplayVariationsFromLibrary('${cap.name}')" style="background: #1a1a1a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 14px; margin-bottom: 2px;">🔄</div>';
                        html += '<div style="font-size: 10px; color: #F60;">VARIATIONS</div>';
                        html += '</div>';

                        // Fuzz Signal
                        html += `<div onclick="txFuzzFromLibrary('${cap.name}')" style="background: #1a1a1a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 14px; margin-bottom: 2px;">🎲</div>';
                        html += '<div style="font-size: 10px; color: #F60;">FUZZ</div>';
                        html += '</div>';

                        // Delete button
                        html += `<div onclick="confirmDeleteCapture('${cap.name}')" style="background: #1a1a1a; padding: 12px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 14px; margin-bottom: 2px;">🗑️</div>';
                        html += '<div style="font-size: 10px; color: #f00;">DELETE</div>';
                        html += '</div>';

                        html += '</div>';
                        html += '</div>';
                    });

                    html += '</div>';

                    // Footer tip
                    html += '<div style="padding: 15px; background: #0a0a0a; border-top: 1px solid #333; font-size: 12px; color: #666; text-align: center;">';
                    html += '💡 RTL-SDR captures are raw IQ samples for advanced analysis';
                    html += '</div>';

                    outputPanel.innerHTML = html;

                } else {
                    outputPanel.innerHTML = '<div style="padding: 40px; text-align: center;">';
                    outputPanel.innerHTML += '<div style="font-size: 48px; margin-bottom: 15px;">📡</div>';
                    outputPanel.innerHTML += '<div style="font-size: 18px; color: #ccc; margin-bottom: 10px;">No RTL-SDR Captures</div>';
                    outputPanel.innerHTML += '<div style="font-size: 14px; color: #666;">Captures made with RTL-SDR hardware<br>will appear here</div>';
                    outputPanel.innerHTML += '</div>';
                }

                // Add close button
                const closeBtn = document.createElement('div');
                closeBtn.className = 'output-close';
                closeBtn.textContent = '✕ CLOSE';
                closeBtn.onclick = closeOutput;
                outputPanel.appendChild(closeBtn);

            } catch (error) {
                outputPanel.innerHTML = `<div style="padding: 20px; color: #f00;">❌ Error: ${error.message}</div>`;
                const closeBtn = document.createElement('div');
                closeBtn.className = 'output-close';
                closeBtn.textContent = '✕ CLOSE';
                closeBtn.onclick = closeOutput;
                outputPanel.appendChild(closeBtn);
            }
        }

        function confirmDeleteCapture(name) {
            if (confirm(`🗑️ Delete Capture?\n\n"${name}"\n\nThis cannot be undone!`)) {
                deleteSignal(name);
            }
        }

        async function replaySignal(name) {
            if (!confirm('⚠️ WARNING: This will transmit RF signal!\n\nOnly replay signals you own.\nContinue?')) return;

            showOutput(`▶️ Replaying "${name}"...`);
            try {
                const response = await fetch(`/api/replay/${name}`, { method: 'POST' });
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function analyzeSignal(name) {
            showOutput(`🔍 Analyzing "${name}"...`);
            try {
                const response = await fetch(`/api/analyze/${name}`);
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function deleteSignal(name) {
            if (!confirm(`Delete "${name}"?`)) return;

            showOutput(`🗑️ Deleting "${name}"...`);
            try {
                const response = await fetch(`/api/capture/${name}`, { method: 'DELETE' });
                const data = await response.json();
                showOutput(JSON.stringify(data, null, 2));
                loadLibrary(); // Refresh
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ==========================================
        // CC1101 Enhanced Functions
        // ==========================================

        // Live capture visualization
        function showLiveCaptureViz(name, freq, duration) {
            const totalDuration = parseFloat(duration);
            let elapsed = 0;

            // Initial display
            let output = '╔══════════════════════════════════════════════════╗\n';
            output += '║          📻 LIVE CAPTURE                         ║\n';
            output += '╚══════════════════════════════════════════════════╝\n\n';
            output += `Signal:    ${name}\n`;
            output += `Frequency: ${freq} MHz\n`;
            output += `Duration:  ${duration}s\n\n`;
            output += '⚡ PRESS REMOTE BUTTON NOW! ⚡\n\n';
            output += '─────────────────────────────────────────────────\n';
            output += 'LIVE WAVEFORM:\n';
            output += '  [Waiting for signal...]\n\n';
            output += 'SIGNAL STRENGTH:\n';
            output += '  RSSI: [░░░░░░░░░░░░░░░░░░░░] --- dBm\n\n';
            output += 'PROGRESS:\n';
            output += '  [                              ] 0%\n';
            output += '  Time: 0.0s / ' + duration + 's\n';

            showOutput(output);

            // Update progress every 100ms
            const interval = setInterval(() => {
                elapsed += 0.1;
                const percent = Math.min(100, (elapsed / totalDuration) * 100);
                const barWidth = 30;
                const filled = Math.floor((percent / 100) * barWidth);
                const empty = barWidth - filled;

                // Generate random waveform (simulated - real one comes from backend)
                const waveform = generateRandomWaveform(50);

                // Generate random RSSI (simulated)
                const rssi = -90 + Math.random() * 30; // -90 to -60
                const rssiBar = generateRSSIBar(rssi, 20);

                let liveOutput = '╔══════════════════════════════════════════════════╗\n';
                liveOutput += '║          📻 LIVE CAPTURE                         ║\n';
                liveOutput += '╚══════════════════════════════════════════════════╝\n\n';
                liveOutput += `Signal:    ${name}\n`;
                liveOutput += `Frequency: ${freq} MHz\n`;
                liveOutput += `Duration:  ${duration}s\n\n`;
                liveOutput += '⚡ CAPTURING... KEEP PRESSING! ⚡\n\n';
                liveOutput += '─────────────────────────────────────────────────\n';
                liveOutput += 'LIVE WAVEFORM:\n';
                liveOutput += '  ' + waveform + '\n\n';
                liveOutput += 'SIGNAL STRENGTH:\n';
                liveOutput += '  RSSI: ' + rssiBar + '\n\n';
                liveOutput += 'PROGRESS:\n';
                liveOutput += '  [' + '='.repeat(filled) + (filled < barWidth ? '>' : '') + ' '.repeat(Math.max(0, empty - 1)) + '] ' + Math.floor(percent) + '%\n';
                liveOutput += '  Time: ' + elapsed.toFixed(1) + 's / ' + duration + 's\n';

                showOutput(liveOutput);

                if (elapsed >= totalDuration) {
                    clearInterval(interval);
                }
            }, 100);
        }

        // Generate random waveform for visualization
        function generateRandomWaveform(width) {
            const chars = ['▁', '▂', '▃', '▄', '▅', '▆', '▇', '█'];
            let waveform = '';
            for (let i = 0; i < width; i++) {
                // More realistic: clusters of high/low
                if (Math.random() > 0.7) {
                    waveform += chars[Math.floor(Math.random() * 4) + 4]; // High
                } else {
                    waveform += chars[Math.floor(Math.random() * 4)]; // Low
                }
            }
            return waveform;
        }

        // Generate RSSI bar
        function generateRSSIBar(rssi, width) {
            // RSSI: -100 (worst) to -30 (best)
            const normalized = Math.max(0, Math.min(100, ((rssi + 100) / 70) * 100));
            const filled = Math.floor((normalized / 100) * width);
            const empty = width - filled;

            const bar = '▓'.repeat(filled) + '░'.repeat(empty);

            let quality = '';
            if (rssi > -60) quality = '✅ STRONG';
            else if (rssi > -80) quality = '⚠️  MODERATE';
            else quality = '❌ WEAK';

            return `[${bar}] ${rssi.toFixed(0)} dBm ${quality}`;
        }

        // Frequency scan animation
        function showScanAnimation(startFreq, endFreq) {
            let currentFreq = parseFloat(startFreq);
            const endF = parseFloat(endFreq);
            const step = 0.1;

            const interval = setInterval(() => {
                let output = '╔══════════════════════════════════════════════════╗\n';
                output += '║          🔍 FREQUENCY SCANNER                    ║\n';
                output += '╚══════════════════════════════════════════════════╝\n\n';
                output += `Range: ${startFreq} - ${endFreq} MHz\n\n`;
                output += '─────────────────────────────────────────────────\n';
                output += 'SCANNING:\n';
                output += `  ► ${currentFreq.toFixed(2)} MHz\n\n`;
                output += 'SPECTRUM:\n';

                // Show spectrum display
                for (let f = parseFloat(startFreq); f <= endF; f += step) {
                    const isScanning = Math.abs(f - currentFreq) < 0.05;
                    const hasSignal = Math.random() > 0.85; // Random signals

                    if (isScanning) {
                        output += '  ► ';
                    } else {
                        output += '    ';
                    }

                    output += `${f.toFixed(2)} MHz `;

                    if (hasSignal && Math.random() > 0.5) {
                        const bars = Math.floor(Math.random() * 10) + 1;
                        output += '█'.repeat(bars);
                    } else {
                        output += '░░░';
                    }
                    output += '\n';
                }

                output += '\n⚡ Scanning for active transmissions...';

                showOutput(output);

                currentFreq += step;
                if (currentFreq > endF) {
                    clearInterval(interval);
                }
            }, 200);
        }

        // Signal Strength Meter
        let rssiMonitorInterval = null;

        async function showSignalStrength() {
            showOutput('📶 SIGNAL STRENGTH METER\n\nInitializing...');

            // Clear any existing interval
            if (rssiMonitorInterval) {
                clearInterval(rssiMonitorInterval);
            }

            let output = '📶 SIGNAL STRENGTH METER\n';
            output += '═══════════════════════════════\n\n';
            output += '💡 TIP: Move your antenna or press\n';
            output += 'remote button to see signal strength.\n\n';
            output += 'Monitoring...\n\n';

            showOutput(output);

            rssiMonitorInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/rssi');
                    const data = await response.json();

                    if (data.error) {
                        appendOutput('\n❌ Error: ' + data.error);
                        clearInterval(rssiMonitorInterval);
                        return;
                    }

                    // Create visual signal strength bars
                    const strength = data.signal_strength || 0;
                    const bars = Math.floor(strength / 10); // 0-10 bars
                    let barDisplay = '';

                    for (let i = 0; i < 10; i++) {
                        if (i < bars) {
                            if (i < 3) {
                                barDisplay += '▓'; // Weak (red)
                            } else if (i < 6) {
                                barDisplay += '▓'; // Medium (yellow)
                            } else {
                                barDisplay += '▓'; // Strong (green)
                            }
                        } else {
                            barDisplay += '░';
                        }
                    }

                    // Build output
                    let rssiOutput = '📶 SIGNAL STRENGTH METER\n';
                    rssiOutput += '═══════════════════════════════\n\n';

                    // Visual bars
                    rssiOutput += `${barDisplay} ${strength}%\n\n`;

                    // Numeric values
                    rssiOutput += `📊 RSSI: ${data.rssi_dbm} dBm\n`;
                    rssiOutput += `📈 Raw: ${data.rssi_raw}\n`;
                    rssiOutput += `💪 Strength: ${strength}%\n\n`;

                    // Signal quality indicator
                    if (strength > 70) {
                        rssiOutput += '✅ EXCELLENT SIGNAL\n';
                    } else if (strength > 40) {
                        rssiOutput += '⚠️  GOOD SIGNAL\n';
                    } else if (strength > 15) {
                        rssiOutput += '⚠️  WEAK SIGNAL\n';
                    } else {
                        rssiOutput += '❌ VERY WEAK / NO SIGNAL\n';
                    }

                    rssiOutput += '\n💡 Monitoring live... (Close to stop)';

                    showOutput(rssiOutput);

                } catch (error) {
                    appendOutput('\n❌ Error reading RSSI: ' + error.message);
                    clearInterval(rssiMonitorInterval);
                }
            }, 500); // Update every 500ms
        }

        async function cc1101QuickTest() {
            showOutput('⚡ QUICK SIGNAL TEST\n\nThis will test common frequencies.\nPress and HOLD your remote button now!\n\nTesting...');

            const commonFreqs = [
                { freq: 433.92, name: '433.92 MHz (most common)' },
                { freq: 315.00, name: '315.00 MHz (US common)' },
                { freq: 433.07, name: '433.07 MHz (alternate)' },
                { freq: 433.42, name: '433.42 MHz (alternate)' }
            ];

            let results = [];

            for (const test of commonFreqs) {
                try {
                    const response = await fetch('/api/cc1101/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            start: test.freq - 0.05,
                            end: test.freq + 0.05,
                            step: 0.05,
                            threshold: -90
                        })
                    });

                    const data = await response.json();

                    if (data.signals && data.signals.length > 0) {
                        const bestSignal = data.signals.reduce((a, b) => a.rssi > b.rssi ? a : b);
                        results.push({
                            freq: test.name,
                            rssi: bestSignal.rssi,
                            detected: true
                        });
                    } else {
                        results.push({
                            freq: test.name,
                            rssi: null,
                            detected: false
                        });
                    }
                } catch (error) {
                    console.error(error);
                }
            }

            // Display results
            let output = '╔══════════════════════════════════════════════════╗\n';
            output += '║          ⚡ QUICK SIGNAL TEST RESULTS            ║\n';
            output += '╚══════════════════════════════════════════════════╝\n\n';

            const detected = results.filter(r => r.detected);

            if (detected.length > 0) {
                output += 'SIGNALS DETECTED:\n';
                detected.forEach(r => {
                    output += `  ✅ ${r.freq}: ${r.rssi} dBm\n`;
                });

                const best = detected.reduce((a, b) => a.rssi > b.rssi ? a : b);
                output += `\n🎯 BEST: ${best.freq}\n`;
                output += `   Use this frequency for capture!\n\n`;

                output += 'NEXT STEP:\n';
                output += `  1. Click "Capture Signal"\n`;
                output += `  2. Use frequency from best result\n`;
                output += `  3. Press remote during 5-second capture\n`;
            } else {
                output += '❌ No signals detected on common frequencies.\n\n';
                output += 'Try:\n';
                output += '  • Hold remote button closer to CC1101\n';
                output += '  • Press and HOLD during test\n';
                output += '  • Use "Scan Frequencies" for wider range\n';
            }

            showOutput(output);
        }

        async function cc1101CaptureSignal() {
            const name = prompt('Signal name:', 'signal_' + Date.now());
            if (!name) return;

            const freq = prompt('Frequency (MHz):', '433.92');
            const duration = prompt('Duration (seconds):', '5');

            if (!freq || !duration) return;

            // Show live capture visualization
            showLiveCaptureViz(name, freq, duration);

            try {
                const response = await fetch('/api/cc1101/capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency: parseFloat(freq),
                        duration: parseFloat(duration),
                        name: name
                    })
                });

                const data = await response.json();

                if (data.status === 'captured_and_saved') {
                    let output = '╔══════════════════════════════════════════════════╗\n';
                    output += '║          📻 SIGNAL CAPTURED & SAVED!             ║\n';
                    output += '╚══════════════════════════════════════════════════╝\n\n';
                    output += `Name:         ${name}\n`;
                    output += `Frequency:    ${freq} MHz\n`;
                    output += `Duration:     ${duration}s\n`;
                    output += `Samples:      ${data.capture.sample_count.toLocaleString()}\n`;
                    output += `Transitions:  ${data.save.timing_count}\n`;
                    output += `RSSI:         ${data.capture.rssi.toFixed(1)} dBm\n\n`;

                    // Signal quality assessment
                    output += '─────────────────────────────────────────────────\n';
                    output += 'SIGNAL QUALITY:\n';

                    const transitions = data.save.timing_count;
                    const rssi = data.capture.rssi;

                    if (transitions > 1000) {
                        output += '  Transitions: ✅ EXCELLENT (strong signal detected)\n';
                    } else if (transitions > 100) {
                        output += '  Transitions: ⚠️  WEAK (may work, try closer)\n';
                    } else {
                        output += '  Transitions: ❌ TOO FEW (probably missed signal)\n';
                    }

                    if (rssi > -60) {
                        output += '  RSSI:        ✅ STRONG signal\n';
                    } else if (rssi > -80) {
                        output += '  RSSI:        ⚠️  MODERATE signal\n';
                    } else {
                        output += '  RSSI:        ❌ WEAK signal (try closer)\n';
                    }

                    output += '\n';

                    // Recommendations
                    if (transitions < 100) {
                        output += '⚠️  WARNING: Very few transitions detected!\n';
                        output += 'Try:\n';
                        output += '  • Press and HOLD button during capture\n';
                        output += '  • Move remote closer to CC1101\n';
                        output += '  • Try different frequency (315 MHz?)\n\n';
                    } else if (transitions > 10000) {
                        output += '✨ Great capture! This should replay well.\n\n';
                    }

                    output += 'NEXT STEPS:\n';
                    output += '  1. Go to "RF Signal Library"\n';
                    output += '  2. Type "decode 1" to see binary data\n';
                    output += '  3. Type "1" to replay signal\n';

                    showOutput(output);

                    // Log activity
                    try {
                        await fetch('/api/activity', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'capture',
                                type: 'rf',
                                name: name,
                                result: 'success'
                            })
                        });
                    } catch (e) {}
                } else {
                    showOutput(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function cc1101ScanFrequencies() {
            const start = prompt('Start frequency (MHz):', '433.0');
            const end = prompt('End frequency (MHz):', '434.0');
            const step = prompt('Step size (MHz):', '0.1');
            const threshold = prompt('RSSI threshold (dBm):', '-80');

            if (!start || !end) return;

            // Show scanning animation
            showScanAnimation(start, end);

            try {
                const response = await fetch('/api/cc1101/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: parseFloat(start),
                        end: parseFloat(end),
                        step: parseFloat(step),
                        threshold: parseFloat(threshold)
                    })
                });

                const data = await response.json();

                if (data.signals && data.signals.length > 0) {
                    let output = '╔══════════════════════════════════════════════════╗\n';
                    output += `║     🔍 FOUND ${data.count} ACTIVE SIGNAL${data.count > 1 ? 'S' : ''}!                  ║\n`;
                    output += '╚══════════════════════════════════════════════════╝\n\n';

                    data.signals.forEach((sig, i) => {
                        output += `${i + 1}. ${sig.frequency} MHz - RSSI: ${sig.rssi} dBm\n`;
                    });

                    output += `\n📡 Scanned range: ${data.range}`;
                    showOutput(output);
                } else {
                    showOutput(`❌ No signals found in ${data.range}\n\nTry:\n- Moving closer to signal source\n- Adjusting RSSI threshold\n- Different frequency range`);
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function cc1101ShowLibrary() {
            const outputPanel = document.getElementById('output');
            outputPanel.innerHTML = '<div style="padding: 20px; text-align: center;">📚 Loading library...</div>';
            outputPanel.classList.add('active');

            try {
                const response = await fetch('/api/cc1101/library');
                const data = await response.json();

                if (data.signals && data.signals.length > 0) {
                    let html = '';

                    // Header
                    html += '<div style="padding: 20px; background: #1a1a1a; border-bottom: 2px solid #FF6600;">';
                    html += '<div style="font-size: 24px; font-weight: bold; color: #FF6600;">📚 RF Signal Library</div>';
                    html += `<div style="font-size: 14px; color: #888; margin-top: 5px;">${data.count} saved signals</div>`;
                    html += '</div>';

                    // Signals list
                    html += '<div style="padding: 15px;">';

                    data.signals.forEach((sig, i) => {
                        const timeAgo = getTimeAgo(sig.timestamp);

                        html += '<div style="background: #1a1a1a; margin-bottom: 12px; border-radius: 8px; border: 1px solid #333; overflow: hidden;">';

                        // Signal info
                        html += '<div style="padding: 15px;">';
                        html += `<div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 8px;">📡 ${sig.name}</div>`;
                        html += `<div style="font-size: 13px; color: #888; margin-bottom: 4px;">🔊 ${sig.frequency} MHz • ⏱️ ${sig.duration}s</div>`;
                        html += `<div style="font-size: 12px; color: #666;">🕒 ${timeAgo}</div>`;
                        html += '</div>';

                        // Action buttons
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #000;">';

                        // Replay button
                        html += `<div onclick="cc1101ReplaySignal('${sig.name}')" style="background: #2a2a2a; padding: 15px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 18px; margin-bottom: 3px;">▶️</div>';
                        html += '<div style="font-size: 11px; color: #0f0;">REPLAY</div>';
                        html += '</div>';

                        // Decode button
                        html += `<div onclick="cc1101DecodeSignal('${sig.name}')" style="background: #2a2a2a; padding: 15px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 18px; margin-bottom: 3px;">🔍</div>';
                        html += '<div style="font-size: 11px; color: #ff0;">DECODE</div>';
                        html += '</div>';

                        // Delete button
                        html += `<div onclick="confirmDeleteSignal('${sig.name}')" style="background: #2a2a2a; padding: 15px; text-align: center; cursor: pointer;">`;
                        html += '<div style="font-size: 18px; margin-bottom: 3px;">🗑️</div>';
                        html += '<div style="font-size: 11px; color: #f00;">DELETE</div>';
                        html += '</div>';

                        html += '</div>';
                        html += '</div>';
                    });

                    html += '</div>';

                    // Footer tip
                    html += '<div style="padding: 15px; background: #0a0a0a; border-top: 1px solid #333; font-size: 12px; color: #666; text-align: center;">';
                    html += '💡 Tap any button to replay, decode, or delete signals';
                    html += '</div>';

                    outputPanel.innerHTML = html;

                } else {
                    outputPanel.innerHTML = '<div style="padding: 40px; text-align: center;">';
                    outputPanel.innerHTML += '<div style="font-size: 48px; margin-bottom: 15px;">📚</div>';
                    outputPanel.innerHTML += '<div style="font-size: 18px; color: #ccc; margin-bottom: 10px;">Library Empty</div>';
                    outputPanel.innerHTML += '<div style="font-size: 14px; color: #666;">Capture signals in Sub-GHz Tools menu</div>';
                    outputPanel.innerHTML += '</div>';
                }

                // Add close button
                const closeBtn = document.createElement('div');
                closeBtn.className = 'output-close';
                closeBtn.textContent = '✕ CLOSE';
                closeBtn.onclick = closeOutput;
                outputPanel.appendChild(closeBtn);

            } catch (error) {
                outputPanel.innerHTML = `<div style="padding: 20px; color: #f00;">❌ Error: ${error.message}</div>`;
                const closeBtn = document.createElement('div');
                closeBtn.className = 'output-close';
                closeBtn.textContent = '✕ CLOSE';
                closeBtn.onclick = closeOutput;
                outputPanel.appendChild(closeBtn);
            }
        }

        function confirmDeleteSignal(name) {
            if (confirm(`🗑️ Delete Signal?\n\n"${name}"\n\nThis cannot be undone!`)) {
                cc1101DeleteSignal(name);
            }
        }

        async function cc1101ReplaySignal(name) {
            if (!confirm(`⚠️ WARNING: This will TRANSMIT RF signal!\n\nSignal: ${name}\n\nOnly replay signals you own or have permission to use.\n\nContinue?`)) return;

            showOutput(`▶️ Transmitting "${name}"...\n\n📡 Broadcasting on original frequency...`);

            try {
                const response = await fetch(`/api/cc1101/transmit/${name}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.status === 'transmitted') {
                    let output = '╔══════════════════════════════════════════════════╗\n';
                    output += '║           📡 SIGNAL TRANSMITTED!                 ║\n';
                    output += '╚══════════════════════════════════════════════════╝\n\n';
                    output += `Signal:       ${name}\n`;
                    output += `Frequency:    ${data.frequency} MHz\n`;
                    output += `Timings sent: ${data.timing_count}\n\n`;
                    output += '✅ Transmission complete!';
                    showOutput(output);
                } else {
                    showOutput(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function cc1101DecodeSignal(name) {
            showOutput(`🔍 Decoding "${name}"...\n\nAnalyzing pulse widths and extracting binary data...`);

            try {
                // Fetch both decode and waveform data
                const [decodeRes, waveformRes] = await Promise.all([
                    fetch(`/api/cc1101/decode/${name}`),
                    fetch(`/api/waveform/${name}`)
                ]);

                const data = await decodeRes.json();
                const waveform = await waveformRes.json();

                if (data.error) {
                    showOutput(`❌ Error: ${data.error}`);
                    return;
                }

                // Format decode output
                let output = '╔══════════════════════════════════════════════════╗\n';
                output += '║          🔍 SIGNAL DECODED!                      ║\n';
                output += '╚══════════════════════════════════════════════════╝\n\n';

                output += `Signal:       ${data.name}\n`;
                output += `Frequency:    ${data.frequency} MHz\n`;
                output += `Duration:     ${data.duration}s\n\n`;

                // Waveform visualization
                if (waveform.simple_waveform) {
                    output += '─────────────────────────────────────────────────\n';
                    output += 'WAVEFORM:\n';
                    output += `  ${waveform.simple_waveform}\n\n`;
                }

                // Pulse analysis
                if (data.pulse_analysis && data.pulse_analysis.clusters) {
                    const clusters = data.pulse_analysis.clusters;
                    output += '─────────────────────────────────────────────────\n';
                    output += 'PULSE WIDTHS:\n';
                    output += `  Short: ${clusters.short.avg}µs (${clusters.short.count} pulses)\n`;
                    output += `  Long:  ${clusters.long.avg}µs (${clusters.long.count} pulses)\n\n`;
                }

                // Binary data
                if (data.binary && data.binary.bit_string) {
                    output += '─────────────────────────────────────────────────\n';
                    output += 'BINARY DATA:\n';
                    const bitString = data.binary.bit_string;

                    // Show in chunks of 32 bits (4 bytes)
                    for (let i = 0; i < bitString.length; i += 32) {
                        const chunk = bitString.substr(i, 32);
                        // Add spaces every 8 bits
                        const formatted = chunk.match(/.{1,8}/g).join(' ');
                        output += `  ${formatted}\n`;
                    }

                    output += `\nTotal bits: ${data.binary.bit_count}\n\n`;
                }

                // Protocol info
                if (data.protocol) {
                    output += '─────────────────────────────────────────────────\n';
                    output += 'PROTOCOL:\n';
                    output += `  Type:     ${data.protocol.type}\n`;
                    output += `  Encoding: ${data.protocol.encoding}\n\n`;

                    // Repeating patterns
                    if (data.protocol.patterns && data.protocol.patterns.length > 0) {
                        output += 'REPEATING PATTERNS:\n';
                        data.protocol.patterns.slice(0, 3).forEach((p, i) => {
                            output += `  ${i + 1}. ${p.pattern}\n`;
                            output += `     Hex: 0x${p.hex} | Repeats: ${p.repeats}x\n`;
                        });
                        output += '\n';
                    }
                }

                output += '✅ Signal decoded! Ready to replay with exact timings.';
                showOutput(output);

            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function cc1101DeleteSignal(name) {
            if (!confirm(`Delete signal "${name}"?`)) return;

            showOutput(`🗑️ Deleting "${name}"...`);

            try {
                const response = await fetch(`/api/cc1101/library/${name}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.status === 'deleted') {
                    showOutput(`✅ Deleted "${name}" from library.`);
                    // Reload library after short delay
                    setTimeout(() => cc1101ShowLibrary(), 1000);
                } else {
                    showOutput(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ==========================================
        // End CC1101 Enhanced Functions
        // ==========================================

        // ==========================================
        // RTL-SDR Enhanced Functions
        // ==========================================

        // Scan 433MHz with live animation and device detection
        async function scan433() {
            closeOutput(); // Close any existing output
            showOutput(''); // Open the overlay

            let devices = [];
            let scanDuration = 30;
            let elapsed = 0;

            // Show initial scan animation
            const animationInterval = setInterval(() => {
                elapsed += 0.5;
                const progress = Math.min(100, (elapsed / scanDuration) * 100);
                const progressBar = generateProgressBar(Math.floor(progress), 100, 40);

                let output = '╔════════════════════════════════════════════════════╗\n';
                output += '║         📡 SCANNING 433MHz DEVICES                 ║\n';
                output += '╚════════════════════════════════════════════════════╝\n\n';
                output += '⚡ LIVE SCAN IN PROGRESS ⚡\n\n';
                output += 'Frequency: 433.92 MHz\n';
                output += 'Mode:      RTL_433 Protocol Decoder\n';
                output += 'Duration:  30 seconds\n\n';
                output += `Time: ${progressBar}\n\n`;

                // Show frequency scanner animation
                const freqBars = generateFrequencyScanAnimation(elapsed);
                output += 'SPECTRUM:\n';
                output += freqBars + '\n\n';

                // Show detected devices so far
                if (devices.length > 0) {
                    output += `\n📻 DEVICES DETECTED: ${devices.length}\n`;
                    output += '═══════════════════════════════════════════════════\n\n';

                    // Sort devices by RSSI (strongest first)
                    const sortedDevices = [...devices].sort((a, b) => {
                        const rssiA = a.rssi || a.snr || -100;
                        const rssiB = b.rssi || b.snr || -100;
                        return rssiB - rssiA;
                    });

                    sortedDevices.forEach((dev, idx) => {
                        const rssi = dev.rssi || dev.snr || 0;
                        const rssiBar = generateRSSIBar(rssi, 15);
                        output += `${idx + 1}. ${dev.model || dev.type || 'Unknown Device'}\n`;
                        output += `   Signal: ${rssiBar}\n`;
                        if (dev.id) output += `   ID: ${dev.id}\n`;
                        output += '\n';
                    });
                } else {
                    output += '\n⏳ Listening for devices...\n';
                    output += '   Press remotes, walk by sensors...\n';
                }

                showOutput(output);
            }, 500);

            // Start actual scan
            try {
                const response = await fetch('/api/scan433');
                const data = await response.json();

                clearInterval(animationInterval);

                if (data.error) {
                    showOutput('❌ ERROR\n\n' + data.message + '\n\n' + (data.raw_output || ''));
                    return;
                }

                devices = data.devices || [];

                // Show final results
                let output = '╔════════════════════════════════════════════════════╗\n';
                output += '║         📡 SCAN COMPLETE                           ║\n';
                output += '╚════════════════════════════════════════════════════╝\n\n';
                output += `✅ Found ${devices.length} device(s)\n`;
                output += `Scan Duration: ${data.scan_duration}\n`;
                output += `Frequency: ${data.frequency}\n\n`;

                if (devices.length === 0) {
                    output += '❌ No devices detected\n\n';
                    output += 'Try:\n';
                    output += '  • Press remote buttons\n';
                    output += '  • Walk near sensors\n';
                    output += '  • Check battery in devices\n';
                } else {
                    // Sort by RSSI
                    const sortedDevices = [...devices].sort((a, b) => {
                        const rssiA = a.rssi || a.snr || -100;
                        const rssiB = b.rssi || b.snr || -100;
                        return rssiB - rssiA;
                    });

                    output += '═══════════════════════════════════════════════════\n\n';

                    sortedDevices.forEach((dev, idx) => {
                        const rssi = dev.rssi || dev.snr || 0;
                        const rssiBar = generateRSSIBar(rssi, 15);
                        const quality = rssi > -60 ? '✅ STRONG' : rssi > -80 ? '⚠️  MODERATE' : '❌ WEAK';

                        output += `${idx + 1}. ${dev.model || dev.type || 'Unknown'}\n`;
                        output += `───────────────────────────────────────────────────\n`;
                        output += `Signal: ${rssiBar} ${quality}\n`;

                        if (dev.id) output += `ID:     ${dev.id}\n`;
                        if (dev.channel) output += `Chan:   ${dev.channel}\n`;
                        if (dev.battery_ok !== undefined) {
                            output += `Battery: ${dev.battery_ok ? '✅ OK' : '⚠️  LOW'}\n`;
                        }
                        if (dev.temperature_C) output += `Temp:   ${dev.temperature_C}°C\n`;
                        if (dev.humidity) output += `Humid:  ${dev.humidity}%\n`;
                        if (dev.pressure_hPa) output += `Press:  ${dev.pressure_hPa} hPa\n`;
                        output += '\n';
                    });
                }

                showOutput(output);

            } catch (error) {
                clearInterval(animationInterval);
                showOutput('❌ Error: ' + error.message);
            }
        }

        // Generate RSSI bar (helper)
        function generateRSSIBar(rssi, width) {
            const normalized = Math.max(0, Math.min(100, ((rssi + 100) / 70) * 100));
            const filled = Math.floor((normalized / 100) * width);
            const empty = width - filled;
            return '▓'.repeat(filled) + '░'.repeat(empty) + ` ${rssi.toFixed(0)} dBm`;
        }

        // Generate progress bar (helper)
        function generateProgressBar(current, total, width) {
            const percent = Math.floor((current / total) * 100);
            const filled = Math.floor((current / total) * width);
            const empty = width - filled - 1;

            let bar;
            if (filled >= width) {
                bar = '='.repeat(width);
            } else {
                bar = '='.repeat(filled) + '>' + ' '.repeat(empty);
            }

            return `[${bar}] ${percent}%`;
        }

        // Generate frequency scan animation
        function generateFrequencyScanAnimation(time) {
            const freqs = [433.0, 433.2, 433.4, 433.6, 433.8, 434.0];
            const currentIdx = Math.floor((time * 2) % freqs.length);

            let output = '';
            freqs.forEach((freq, idx) => {
                const isActive = idx === currentIdx;
                const bars = isActive ? '████' : '░░░░';
                const marker = isActive ? '► ' : '  ';
                output += `${marker}${freq.toFixed(1)} MHz ${bars}\n`;
            });
            return output;
        }

        // ==========================================
        // NFC Enhanced Functions
        // ==========================================

        // Continuous NFC scanner - scans for multiple cards
        async function scanNFCContinuous() {
            closeOutput();
            showOutput('');

            let detectedCards = [];
            let scanning = true;
            let scanTime = 0;
            const maxDuration = 60; // 60 seconds max

            // Animation loop
            const animationInterval = setInterval(() => {
                scanTime += 0.5;

                let output = '╔════════════════════════════════════════════════════╗\n';
                output += '║       💳 CONTINUOUS NFC SCANNER                    ║\n';
                output += '╚════════════════════════════════════════════════════╝\n\n';
                output += '⚡ WAITING FOR CARDS ⚡\n\n';
                output += 'Tap multiple cards to compare them\n';
                output += `Time: ${scanTime.toFixed(1)}s / ${maxDuration}s\n\n`;

                // Animated NFC field
                const wave = Math.floor(scanTime * 4) % 4;
                const waves = ['◐', '◓', '◑', '◒'];
                output += `   ${waves[wave]} NFC Field Active ${waves[wave]}\n\n`;

                // Show detected cards
                if (detectedCards.length > 0) {
                    output += `\n📇 CARDS DETECTED: ${detectedCards.length}\n`;
                    output += '═══════════════════════════════════════════════════\n\n';

                    detectedCards.forEach((card, idx) => {
                        output += `${idx + 1}. ${card.type || 'Unknown'}\n`;
                        output += `   UID: ${card.uid}\n`;
                        output += `   Detected: ${new Date(card.timestamp).toLocaleTimeString()}\n`;
                        output += '\n';
                    });
                } else {
                    output += '\n⏳ No cards detected yet...\n';
                    output += '   Place card on reader\n';
                }

                output += '\nPress CLOSE to stop scanning';

                showOutput(output);

                if (scanTime >= maxDuration) {
                    clearInterval(animationInterval);
                    clearInterval(scanInterval);
                    scanning = false;
                }
            }, 500);

            // Scan loop
            const scanInterval = setInterval(async () => {
                if (!scanning) return;

                try {
                    const response = await fetch('/api/nfc');
                    const data = await response.json();

                    if (data.card_present && data.uid_readable) {
                        // Check if card already detected
                        const alreadyDetected = detectedCards.some(c => c.uid === data.uid_readable);

                        if (!alreadyDetected) {
                            detectedCards.push({
                                uid: data.uid_readable,
                                type: data.likely_type || data.type,
                                manufacturer: data.manufacturer,
                                timestamp: Date.now()
                            });
                        }
                    }
                } catch (error) {
                    console.error('NFC scan error:', error);
                }
            }, 1000);

            // Store intervals so close button can clear them
            window.nfcScanIntervals = { animationInterval, scanInterval };
        }

        // ==========================================
        // Spectrum Waterfall
        // ==========================================

        let waterfallCanvas = null;
        let waterfallCtx = null;
        let waterfallEventSource = null;
        let waterfallData = [];
        const waterfallMaxLines = 400; // Keep last 400 scans

        async function showWaterfall() {
            closeOutput();
            const outputPanel = document.getElementById('output');
            const closeBtn = outputPanel.querySelector('.output-close');

            // Create waterfall UI
            outputPanel.innerHTML = `
                <div class="waterfall-container">
                    <div class="waterfall-info">
                        <span id="waterfall-freq-range">433.0 - 434.0 MHz</span>
                        <span id="waterfall-status">Starting...</span>
                    </div>
                    <canvas id="waterfall-canvas" class="waterfall-canvas"></canvas>
                    <div class="waterfall-controls">
                        <button class="action-btn" onclick="stopWaterfall()" style="flex: 0 0 auto; min-width: 150px;">⏹️ STOP</button>
                        <span style="color: #888; font-size: 12px;">Click on waterfall to tune to frequency</span>
                    </div>
                </div>
            `;
            outputPanel.appendChild(closeBtn);
            outputPanel.classList.add('active');

            // Setup canvas
            waterfallCanvas = document.getElementById('waterfall-canvas');
            waterfallCtx = waterfallCanvas.getContext('2d');

            // Set canvas size
            waterfallCanvas.width = 512;  // Frequency bins
            waterfallCanvas.height = 400; // History lines

            // Click handler for tuning
            waterfallCanvas.addEventListener('click', handleWaterfallClick);

            // Start streaming
            startWaterfallStream();
        }

        function startWaterfallStream() {
            waterfallData = [];

            // Use EventSource for server-sent events
            waterfallEventSource = new EventSource('/api/waterfall/stream?start=433000000&end=434000000');

            waterfallEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateWaterfall(data.spectrum);
                document.getElementById('waterfall-status').textContent = `✅ Live (${data.spectrum.length} bins)`;
            };

            waterfallEventSource.onerror = function() {
                document.getElementById('waterfall-status').textContent = '❌ Error - RTL-SDR busy?';
            };
        }

        function updateWaterfall(spectrum) {
            if (!waterfallCtx || !waterfallCanvas) return;

            // Add new scan line to data
            waterfallData.push(spectrum);

            // Keep only last N lines
            if (waterfallData.length > waterfallMaxLines) {
                waterfallData.shift();
            }

            // Draw waterfall
            drawWaterfall();
        }

        function drawWaterfall() {
            const width = waterfallCanvas.width;
            const height = waterfallCanvas.height;

            // Clear canvas
            waterfallCtx.fillStyle = '#000';
            waterfallCtx.fillRect(0, 0, width, height);

            // Draw each scan line
            waterfallData.forEach((scan, lineIndex) => {
                const y = height - 1 - lineIndex; // Scroll upward

                scan.forEach((point, binIndex) => {
                    const x = Math.floor((binIndex / scan.length) * width);
                    const power = point[1]; // dB value

                    // Map power to color
                    const color = powerToColor(power);

                    waterfallCtx.fillStyle = color;
                    waterfallCtx.fillRect(x, y, Math.ceil(width / scan.length) + 1, 1);
                });
            });
        }

        function powerToColor(db) {
            // Typical range: -40 (strong) to -90 (weak)
            // Normalize to 0-1
            const normalized = Math.max(0, Math.min(1, (db + 90) / 50));

            // Create heat map color
            let r, g, b;

            if (normalized < 0.25) {
                // Blue to cyan
                r = 0;
                g = Math.floor(normalized * 4 * 255);
                b = 255;
            } else if (normalized < 0.5) {
                // Cyan to green
                r = 0;
                g = 255;
                b = Math.floor((0.5 - normalized) * 4 * 255);
            } else if (normalized < 0.75) {
                // Green to yellow
                r = Math.floor((normalized - 0.5) * 4 * 255);
                g = 255;
                b = 0;
            } else {
                // Yellow to red
                r = 255;
                g = Math.floor((1 - normalized) * 4 * 255);
                b = 0;
            }

            return `rgb(${r},${g},${b})`;
        }

        function handleWaterfallClick(event) {
            const rect = waterfallCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const freqPercent = x / rect.width;

            // Calculate clicked frequency
            const startFreq = 433.0;
            const endFreq = 434.0;
            const clickedFreq = startFreq + (freqPercent * (endFreq - startFreq));

            if (confirm(`Tune to ${clickedFreq.toFixed(3)} MHz?`)) {
                stopWaterfall();
                // TODO: Add capture at this frequency
                showOutput(`📻 Frequency selected: ${clickedFreq.toFixed(3)} MHz\n\nUse CC1101 Capture to record this frequency.`);
            }
        }

        function stopWaterfall() {
            if (waterfallEventSource) {
                waterfallEventSource.close();
                waterfallEventSource = null;
            }
            waterfallCanvas = null;
            waterfallCtx = null;
            waterfallData = [];
        }

        // Override closeOutput to stop waterfall
        const originalCloseOutputWaterfall = closeOutput;
        closeOutput = function() {
            stopWaterfall();
            originalCloseOutputWaterfall();
        };

        // ==========================================
        // End Enhanced Functions
        // ==========================================

        // Hardware Check
        async function checkHardware() {
            showOutput('🔧 Checking hardware...');
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                let output = '🔧 Hardware Status:\n\n';
                output += `NFC (PN532): ${data.pn532 === 'initialized' ? '✅' : '❌'}\n`;
                output += `RTL-SDR: ${data.rtl_sdr === 'detected' ? '✅' : '❌'}\n`;
                output += `CC1101: ${data.cc1101 === 'initialized' ? '✅' : '⚠️'}\n`;
                
                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // Check hardware status
        async function checkHardwareStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update status dots
                const nfcDot = document.getElementById('nfc-dot');
                const rtlDot = document.getElementById('rtl-dot');
                const cc1101Dot = document.getElementById('cc1101-dot');

                nfcDot.className = data.nfc ? 'status-dot active' : 'status-dot inactive';
                rtlDot.className = data.rtl_sdr ? 'status-dot active' : 'status-dot inactive';
                cc1101Dot.className = data.cc1101 ? 'status-dot active' : 'status-dot inactive';
            } catch (error) {
                console.error('Hardware status check failed:', error);
            }
        }

        // Mobile: Swipe down to close output panel
        let touchStartY = 0;
        let touchEndY = 0;

        document.addEventListener('touchstart', function(e) {
            const outputPanel = document.getElementById('output');
            if (outputPanel.classList.contains('active')) {
                touchStartY = e.changedTouches[0].screenY;
            }
        }, false);

        document.addEventListener('touchend', function(e) {
            const outputPanel = document.getElementById('output');
            if (outputPanel.classList.contains('active')) {
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }
        }, false);

        function handleSwipe() {
            // Swipe down to close (at least 100px)
            if (touchEndY - touchStartY > 100) {
                closeOutput();
            }
        }

        // Welcome Screen Functions
        function hideWelcomeScreen() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('breadcrumb').style.display = 'block';
        }

        async function checkWelcomeHardware() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update CC1101
                const cc1101El = document.getElementById('welcome-cc1101');
                if (data.cc1101) {
                    cc1101El.innerHTML = '📡 CC1101: <span style="color: #0f0;">✅ Ready</span>';
                } else {
                    cc1101El.innerHTML = '📡 CC1101: <span style="color: #f00;">❌ Not detected</span>';
                }

                // Update NFC
                const nfcEl = document.getElementById('welcome-nfc');
                if (data.nfc) {
                    nfcEl.innerHTML = '💳 PN532 (NFC): <span style="color: #0f0;">✅ Ready</span>';
                } else {
                    nfcEl.innerHTML = '💳 PN532 (NFC): <span style="color: #f00;">❌ Not detected</span>';
                }

                // Update RTL-SDR
                const rtlEl = document.getElementById('welcome-rtl');
                if (data.rtl_sdr) {
                    rtlEl.innerHTML = '📻 RTL-SDR: <span style="color: #0f0;">✅ Ready</span>';
                    // Show RTL-SDR menu item
                    document.getElementById('rtl-sdr-menu-item').style.display = 'flex';
                } else {
                    rtlEl.innerHTML = '📻 RTL-SDR: <span style="color: #ff0;">⚠️ Not connected (optional)</span>';
                    // Hide RTL-SDR menu item
                    document.getElementById('rtl-sdr-menu-item').style.display = 'none';
                }

            } catch (error) {
                console.error('Hardware check failed:', error);
            }
        }

        // Initialize
        window.onload = async function() {
            // Hide breadcrumb on welcome screen
            document.getElementById('breadcrumb').style.display = 'none';

            // Check hardware for welcome screen
            await checkWelcomeHardware();

            // Also check for status bar
            await checkHardwareStatus();

            // Auto-hide welcome screen after 3 seconds (optional)
            // setTimeout(hideWelcomeScreen, 3000);
        };

        // ═══════════════════════════════════════════════════════════════
        // BLUETOOTH FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        // Global variable to store last scan results
        let lastBluetoothScanResults = null;

        async function bluetoothScan(scanType) {
            const scanTypes = {
                'ble': '📱 Scanning BLE devices (10s)...',
                'classic': '🎧 Scanning Classic Bluetooth (10s)...',
                'comprehensive': '🔍 Scanning ALL Bluetooth (15s)...'
            };

            showOutput(scanTypes[scanType] + '\n\nSearching for nearby devices...');

            try {
                const response = await fetch('/api/bluetooth/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: scanType, duration: scanType === 'comprehensive' ? 15 : 10 })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Store results globally
                    lastBluetoothScanResults = data.devices || [];

                    // Create HTML output with clickable devices
                    const outputPanel = document.getElementById('output');
                    const closeBtn = outputPanel.querySelector('.output-close');

                    let html = `<div style="font-family: monospace; white-space: pre-wrap;">`;
                    html += `╔══════════════════════════════════════════╗\n`;
                    html += `║   🔵 BLUETOOTH SCAN RESULTS            ║\n`;
                    html += `╚══════════════════════════════════════════╝\n\n`;
                    html += `Found: ${data.total_count || data.count} devices\n`;
                    if (data.ble_count !== undefined) {
                        html += `BLE: ${data.ble_count} | Classic: ${data.classic_count}\n`;
                    }
                    html += `\n`;

                    if (data.devices && data.devices.length > 0) {
                        data.devices.forEach((device, index) => {
                            html += `<div style="border-bottom: 1px solid #333; padding: 10px 0; cursor: pointer;"
                                          onclick="saveBluetoothDevice(${index})"
                                          onmouseover="this.style.background='#2a2a2a'"
                                          onmouseout="this.style.background='transparent'">`;
                            html += `<strong>Device ${index + 1}:</strong> ${device.name || '(Unknown)'}\n`;
                            html += `Address: ${device.address}\n`;
                            html += `Type: ${device.type}`;
                            if (device.rssi) html += ` | RSSI: ${device.rssi} dBm`;
                            html += `\n<span style="color: #FF6600;">💾 Click to save</span>`;
                            html += `</div>`;
                        });
                        html += `\n<div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-left: 4px solid #FF6600;">`;
                        html += `💡 <strong>TIP:</strong> Click any device above to save it to your library!</div>`;
                    } else {
                        html += `\nNo devices found.\n`;
                        html += `\nTip: Make sure Bluetooth is enabled\n`;
                        html += `on your phone/devices and they are\n`;
                        html += `in discoverable mode.`;
                    }

                    html += `</div>`;

                    outputPanel.innerHTML = html;
                    outputPanel.appendChild(closeBtn);
                    outputPanel.classList.add('active');

                } else {
                    showOutput('❌ Error: ' + (data.message || 'Scan failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function saveBluetoothDevice(deviceIndex) {
            const device = lastBluetoothScanResults[deviceIndex];
            if (!device) {
                showOutput('❌ Error: Device not found');
                return;
            }

            // Prompt for device name
            const defaultName = device.name && device.name !== '(Unknown)' && device.name !== '(unknown)'
                ? device.name.replace(/[^a-zA-Z0-9_-]/g, '_')
                : `device_${device.address.replace(/:/g, '')}`;

            const name = prompt(`Save device as:\n\n${device.name || 'Unknown'}\n${device.address}\n\nEnter name:`, defaultName);

            if (!name) return; // User cancelled

            showOutput(`💾 Saving "${name}"...\n\nDevice: ${device.name || 'Unknown'}\nAddress: ${device.address}`);

            try {
                const response = await fetch('/api/bluetooth/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: device,
                        name: name
                    })
                });
                const result = await response.json();

                if (result.status === 'saved') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   ✅ DEVICE SAVED!                     ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Name: ${name}\n`;
                    output += `Address: ${device.address}\n`;
                    output += `Type: ${device.type}\n`;
                    if (device.rssi) output += `RSSI: ${device.rssi} dBm\n`;
                    output += `\n✅ Saved to Bluetooth library!\n\n`;
                    output += `View in: Bluetooth Scanner → Saved Devices`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (result.message || 'Save failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function bluetoothShowLibrary() {
            showOutput('📚 Loading Bluetooth library...');

            try {
                const response = await fetch('/api/bluetooth/library');
                const data = await response.json();

                let output = `╔══════════════════════════════════════════╗\n`;
                output += `║   📚 SAVED BLUETOOTH DEVICES           ║\n`;
                output += `╚══════════════════════════════════════════╝\n\n`;
                output += `Total devices: ${data.count}\n\n`;

                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach((device, index) => {
                        output += `─────────────────────────────────────────\n`;
                        output += `${device.saved_name}\n`;
                        output += `  Address: ${device.address}\n`;
                        output += `  Type: ${device.type}\n`;
                    });
                } else {
                    output += `No saved devices.\n\n`;
                    output += `Scan for devices and save them\n`;
                    output += `from the scan results!`;
                }

                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function bluetoothReset() {
            const confirmMsg = "🔄 Reset Bluetooth Adapter?\n\nThis will:\n• Kill stuck processes\n• Reset adapter\n• Restart Bluetooth service\n\nUse this if scans stop working.\n\nContinue?";
            if (!confirm(confirmMsg)) return;

            showOutput('🔄 Resetting Bluetooth adapter...\n\nThis may take 5-10 seconds...');

            try {
                const response = await fetch('/api/bluetooth/reset', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   ✅ BLUETOOTH RESET COMPLETE          ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `${data.message}\n\n`;
                    output += `Bluetooth adapter has been reset.\n`;
                    output += `Scanning should work normally now.\n\n`;
                    output += `Try scanning again!`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Reset failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // WIFI FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function wifiShowStatus() {
            showOutput('📶 Checking WiFi status...');

            try {
                const response = await fetch('/api/wifi/status');
                const data = await response.json();

                let output = `╔══════════════════════════════════════════╗\n`;
                output += `║   📶 WIFI STATUS                       ║\n`;
                output += `╚══════════════════════════════════════════╝\n\n`;

                output += `Mode: ${data.mode.toUpperCase()}\n\n`;

                if (data.mode === 'client') {
                    output += `Connected to: ${data.connected_to || 'N/A'}\n`;
                    output += `IP Address: ${data.ip_address || 'N/A'}\n`;
                } else if (data.mode === 'hotspot') {
                    output += `═══════════════════════════════════════\n`;
                    output += `🔥 HOTSPOT ACTIVE!\n`;
                    output += `═══════════════════════════════════════\n\n`;
                    output += `SSID: ${data.hotspot_ssid}\n`;
                    output += `IP: ${data.hotspot_ip}\n\n`;
                    output += `📱 TO CONNECT FROM IPAD/PHONE:\n\n`;
                    output += `1. Connect to WiFi: ${data.hotspot_ssid}\n`;
                    output += `2. Password: piflip123\n`;
                    output += `3. Open browser:\n`;
                    output += `   ${data.access_url}\n\n`;
                    output += `You can now control PiFlip from\n`;
                    output += `your iPad, iPhone, or any device!\n`;
                } else {
                    output += `Status: ${data.mode}\n`;
                }

                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function wifiToggleHotspot() {
            showOutput('🔄 Toggling WiFi mode...\n\nThis may take 5-10 seconds...');

            try {
                const response = await fetch('/api/wifi/toggle', {
                    method: 'POST'
                });
                const data = await response.json();

                let output = '';

                if (data.status === 'enabled') {
                    output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🔥 HOTSPOT ENABLED!                  ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `SSID: ${data.ssid}\n`;
                    output += `Password: ${data.password}\n`;
                    output += `IP: ${data.ip}\n\n`;
                    output += `📱 CONNECT FROM YOUR DEVICE:\n\n`;
                    data.instructions.forEach(inst => {
                        output += `${inst}\n`;
                    });
                } else if (data.status === 'disabled') {
                    output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   ✅ HOTSPOT DISABLED                  ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `${data.message}\n\n`;
                    output += `Reconnecting to WiFi network...`;
                } else {
                    output = `Status: ${data.status}\n`;
                    output += `Message: ${data.message || 'Unknown'}`;
                }

                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function wifiScanNetworks() {
            showOutput('🔍 Scanning WiFi networks...\n\nThis may take 10 seconds...');

            try {
                const response = await fetch('/api/wifi/scan');
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🔍 WIFI NETWORKS                     ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Found: ${data.count} networks\n\n`;

                    if (data.networks && data.networks.length > 0) {
                        data.networks.forEach((network, index) => {
                            output += `─────────────────────────────────────────\n`;
                            output += `${index + 1}. ${network.ssid}\n`;
                            if (network.quality) output += `   Signal: ${network.quality}\n`;
                            output += `   ${network.encrypted ? '🔒 Encrypted' : '🔓 Open'}\n`;
                        });
                    } else {
                        output += `No networks found.`;
                    }

                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Scan failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // SPECTRUM ANALYZER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function spectrumQuickScan() {
            showOutput('⚡ Quick spectrum scan (433MHz)...\n\nScanning...');

            try {
                const response = await fetch('/api/spectrum/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ center_freq: 433.92, span: 2.0, bins: 256 })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   📊 SPECTRUM SCAN RESULTS             ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Center: ${data.center_freq} MHz\n`;
                    output += `Span: ${data.span} MHz\n`;
                    output += `Bins: ${data.bins}\n\n`;

                    if (data.peak) {
                        output += `═══ PEAK SIGNAL ═══\n`;
                        output += `Frequency: ${data.peak.frequency.toFixed(2)} MHz\n`;
                        output += `Power: ${data.peak.power.toFixed(1)} dBm\n\n`;
                    }

                    output += `Range: ${data.center_freq - data.span/2} - ${data.center_freq + data.span/2} MHz\n`;

                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Scan failed\n\nNote: RTL-SDR must not be in use by dump1090'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message + '\n\nNote: Make sure RTL-SDR is not in use');
            }
        }

        async function spectrumWaterfallScan() {
            showOutput('🌊 Starting waterfall...\n\nThis will take 12 seconds.\n\n');
            
            const freq = 433.92;
            const span = 2.0;
            const maxScans = 40;
            let scanCount = 0;
            let waterfallLines = [];
            
            try {
                for (let i = 0; i < maxScans; i++) {
                    const response = await fetch('/api/spectrum/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ center_freq: freq, span: span, bins: 60 })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        scanCount++;
                        let line = '';
                        const chars = ' .:-=+*#@';
                        
                        if (data.spectrum) {
                            const powers = data.spectrum.map(p => p.power);
                            const minPower = Math.min(...powers);
                            const maxPower = Math.max(...powers);
                            const range = maxPower - minPower || 1;
                            
                            for (const point of data.spectrum) {
                                const normalized = (point.power - minPower) / range;
                                const charIdx = Math.min(chars.length - 1, Math.floor(normalized * chars.length));
                                line += chars[charIdx];
                            }
                        }
                        
                        waterfallLines.push(line);
                        if (waterfallLines.length > 20) waterfallLines.shift();
                        
                        let output = 'LIVE WATERFALL\n';
                        output += (freq - span/2).toFixed(1) + ' MHz to ' + (freq + span/2).toFixed(1) + ' MHz\n\n';
                        
                        for (const wfLine of waterfallLines) {
                            output += wfLine + '\n';
                        }
                        
                        if (data.peak) {
                            output += '\nPeak: ' + data.peak.frequency.toFixed(2) + ' MHz at ' + data.peak.power.toFixed(1) + ' dBm\n';
                        }
                        
                        output += '\nScan: ' + scanCount + '/' + maxScans;
                        showOutput(output);
                        
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } else {
                        showOutput('Error: ' + (data.message || 'Scan failed'));
                        break;
                    }
                }
                
                showOutput('Waterfall complete! Total scans: ' + scanCount);
                
            } catch (error) {
                showOutput('Error: ' + error.message);
            }
        }

        async function spectrumCustomScan() {
            const freq = prompt('Center frequency (MHz):', '433.92');
            if (!freq) return;

            const span = prompt('Span (MHz):', '2.0');
            if (!span) return;

            showOutput(`⚡ Custom scan: ${freq} MHz ± ${parseFloat(span)/2} MHz\n\nScanning...`);

            try {
                const response = await fetch('/api/spectrum/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        center_freq: parseFloat(freq),
                        span: parseFloat(span),
                        bins: 256
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   📊 CUSTOM SPECTRUM SCAN              ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Center: ${data.center_freq} MHz\n`;
                    output += `Span: ${data.span} MHz\n`;
                    output += `Range: ${data.center_freq - data.span/2} - ${data.center_freq + data.span/2} MHz\n\n`;

                    if (data.peak) {
                        output += `═══ PEAK SIGNAL ═══\n`;
                        output += `Frequency: ${data.peak.frequency.toFixed(2)} MHz\n`;
                        output += `Power: ${data.peak.power.toFixed(1)} dBm\n`;
                    }

                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Scan failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // ADVANCED TX FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function txReplayVariations() {
            const signalName = prompt('Enter signal name to replay with variations:');
            if (!signalName) return;

            showOutput(`🔄 Replaying "${signalName}" with variations...\n\nTrying multiple frequencies and timings...`);

            try {
                const response = await fetch(`/api/tx/replay_variations/${signalName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency_offsets: [-0.5, -0.25, 0, 0.25, 0.5],
                        timing_variations: [0.95, 1.0, 1.05]
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🔄 REPLAY WITH VARIATIONS            ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Signal: ${signalName}\n`;
                    output += `Variations tried: ${data.variations_tried}\n\n`;
                    output += `✅ Transmitted at multiple frequencies\n`;
                    output += `   and timing variations!\n\n`;
                    output += `If your device didn't respond, the\n`;
                    output += `captured signal may need different\n`;
                    output += `modulation or encoding.`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Replay failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function txBruteForce() {
            const frequency = parseFloat(prompt('Enter frequency (MHz):', '433.92'));
            if (!frequency) return;

            const bitLength = parseInt(prompt('Enter bit length (8-16):', '8'));
            if (!bitLength || bitLength < 1 || bitLength > 16) {
                showOutput('❌ Bit length must be between 1 and 16');
                return;
            }

            const totalCodes = Math.pow(2, bitLength);
            const confirmMsg = `⚠️ WARNING\n\nThis will transmit ${totalCodes} codes at ${frequency} MHz.\n\nOnly use on YOUR OWN devices!\n\nContinue?`;
            if (!confirm(confirmMsg)) return;

            showOutput(`🔓 Brute forcing ${totalCodes} codes...\n\nFrequency: ${frequency} MHz\nBit length: ${bitLength}\n\nThis will take ~${(totalCodes * 0.1).toFixed(1)} seconds`);

            try {
                const response = await fetch('/api/tx/brute_force', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency: frequency,
                        bit_length: bitLength
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🔓 BRUTE FORCE COMPLETE              ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Codes transmitted: ${data.codes_transmitted}\n`;
                    output += `Total possible: ${data.total_codes}\n\n`;
                    output += `✅ All codes sent!\n\n`;
                    output += `Did your device respond?\n`;
                    output += `If not, it may use a different\n`;
                    output += `protocol or longer code.`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Brute force failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function txFuzzSignal() {
            const signalName = prompt('Enter signal name to fuzz:');
            if (!signalName) return;

            const fuzzPercent = parseInt(prompt('Fuzz percentage (5-25):', '10'));
            if (!fuzzPercent) return;

            showOutput(`🎲 Fuzzing signal "${signalName}"...\n\nVariation: ±${fuzzPercent}%\nIterations: 50`);

            try {
                const response = await fetch(`/api/tx/fuzz/${signalName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fuzz_percentage: fuzzPercent,
                        iterations: 50
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🎲 SIGNAL FUZZING COMPLETE           ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Signal: ${signalName}\n`;
                    output += `Iterations: ${data.iterations}\n`;
                    output += `Fuzz range: ±${data.fuzz_percentage}%\n\n`;
                    output += `✅ Sent ${data.iterations} fuzzed variants!\n\n`;
                    output += `Each transmission had slightly\n`;
                    output += `different timing. If one worked,\n`;
                    output += `capture it again for reliable replay.`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Fuzzing failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function txRollingCode() {
            const frequency = parseFloat(prompt('Enter frequency (MHz):', '433.92'));
            if (!frequency) return;

            const confirmMsg = `⏱️ ROLLING CODE HELPER\n\nThis will:\n1. Listen for 30 seconds\n2. Capture your remote signal\n3. Immediately replay 5 times\n\nPress your remote when ready!\n\nContinue?`;
            if (!confirm(confirmMsg)) return;

            showOutput(`⏱️ Rolling Code Capture Mode\n\nFrequency: ${frequency} MHz\nListening for 30 seconds...\n\n🚨 PRESS YOUR REMOTE NOW! 🚨`);

            try {
                const response = await fetch('/api/tx/rolling_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency: frequency,
                        capture_duration: 30
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   ⏱️ ROLLING CODE HELPER               ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `✅ Signal captured!\n`;
                    output += `Transitions: ${data.timings_count}\n\n`;
                    output += `✅ Replayed ${data.replayed} times\n\n`;
                    output += `Some rolling code systems accept\n`;
                    output += `recently used codes. Did it work?`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Capture failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function txCustomSignal() {
            const frequency = parseFloat(prompt('Enter frequency (MHz):', '433.92'));
            if (!frequency) return;

            const pattern = prompt('Enter binary pattern (e.g., 1111000011110000):', '101010101010');
            if (!pattern || !/^[01]+$/.test(pattern)) {
                showOutput('❌ Pattern must contain only 0s and 1s');
                return;
            }

            const bitDuration = parseInt(prompt('Bit duration (microseconds):', '500'));
            if (!bitDuration) return;

            showOutput(`✨ Generating custom signal...\n\nFrequency: ${frequency} MHz\nPattern: ${pattern}\nBit duration: ${bitDuration} μs`);

            try {
                const response = await fetch('/api/tx/custom_signal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency: frequency,
                        pattern: pattern,
                        bit_duration_us: bitDuration
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   ✨ CUSTOM SIGNAL TRANSMITTED         ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Frequency: ${data.frequency} MHz\n`;
                    output += `Pattern: ${data.pattern}\n`;
                    output += `Bits: ${data.bit_count}\n\n`;
                    output += `✅ Signal transmitted!\n\n`;
                    output += `You can experiment with different\n`;
                    output += `patterns and durations to create\n`;
                    output += `custom RF signals.`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Transmission failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function txJamFrequency() {
            const frequency = parseFloat(prompt('Enter frequency to jam (MHz):', '433.92'));
            if (!frequency) return;

            const duration = parseInt(prompt('Duration (seconds, max 30):', '10'));
            if (!duration || duration > 30) {
                showOutput('❌ Duration must be 1-30 seconds');
                return;
            }

            const pattern = prompt('Pattern type (noise/tone/pulse):', 'noise');

            const confirmMsg = `⚠️ WARNING - JAMMING\n\nThis will transmit continuously at ${frequency} MHz for ${duration} seconds.\n\n🚨 This may interfere with nearby devices!\n\nEDUCATIONAL USE ONLY!\n\nContinue?`;
            if (!confirm(confirmMsg)) return;

            showOutput(`📡 Jamming ${frequency} MHz...\n\nPattern: ${pattern}\nDuration: ${duration}s\n\n⚠️ TRANSMITTING...`);

            try {
                const response = await fetch('/api/tx/jam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency: frequency,
                        duration: duration,
                        pattern: pattern
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   📡 JAMMING COMPLETE                  ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Frequency: ${data.frequency} MHz\n`;
                    output += `Duration: ${data.duration.toFixed(1)}s\n`;
                    output += `Pattern: ${data.pattern}\n\n`;
                    output += `✅ Transmission complete!\n\n`;
                    output += `This demonstrates how RF jamming\n`;
                    output += `works. Use responsibly!`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Jamming failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // LIBRARY-BASED ADVANCED TX FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function txReplayVariationsFromLibrary(signalName) {
            const confirmMsg = `🔄 Replay "${signalName}" with variations?\n\nThis will transmit at:\n• ±0.5 MHz frequency offsets\n• ±5% timing variations\n\nTotal: 15 variations\n\nContinue?`;
            if (!confirm(confirmMsg)) return;

            showOutput(`🔄 Replaying "${signalName}" with variations...\n\n📡 Transmitting now...\nWatch SDR++ for activity!`);
            showTXIndicator();

            try {
                const response = await fetch(`/api/tx/replay_variations/${signalName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frequency_offsets: [-0.5, -0.25, 0, 0.25, 0.5],
                        timing_variations: [0.95, 1.0, 1.05]
                    })
                });
                const data = await response.json();

                hideTXIndicator();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🔄 REPLAY WITH VARIATIONS            ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Signal: ${signalName}\n`;
                    output += `Variations tried: ${data.variations_tried}\n\n`;
                    output += `✅ Transmission complete!\n\n`;
                    output += `Check SDR++:\n`;
                    output += `• Did you see activity on waterfall?\n`;
                    output += `• Which frequency showed strongest?\n`;
                    output += `• Any device response?`;
                    showOutput(output);
                } else {
                    let errorMsg = data.message || 'Replay failed';
                    let output = `❌ Error: ${errorMsg}\n\n`;

                    if (errorMsg.includes('timing data') || errorMsg.includes('raw IQ')) {
                        output += `ℹ️ Note:\n`;
                        output += `Advanced TX features work with\n`;
                        output += `CC1101 captures only.\n\n`;
                        output += `RTL-SDR captures (.cu8) are raw\n`;
                        output += `IQ samples and can't be transmitted\n`;
                        output += `via CC1101.\n\n`;
                        output += `To use Advanced TX:\n`;
                        output += `1. Use RF Tools (CC1101)\n`;
                        output += `2. Capture signal\n`;
                        output += `3. Signal will have timing data\n`;
                        output += `4. Then use Advanced TX features`;
                    }

                    showOutput(output);
                }
            } catch (error) {
                hideTXIndicator();
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function txFuzzFromLibrary(signalName) {
            const fuzzPercent = parseInt(prompt('Fuzz percentage (5-25):', '10'));
            if (!fuzzPercent) return;

            showOutput(`🎲 Fuzzing "${signalName}"...\n\nVariation: ±${fuzzPercent}%\nIterations: 50\n\n📡 Transmitting now...\nWatch SDR++!`);

            try {
                const response = await fetch(`/api/tx/fuzz/${signalName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fuzz_percentage: fuzzPercent,
                        iterations: 50
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   🎲 SIGNAL FUZZING COMPLETE           ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Signal: ${signalName}\n`;
                    output += `Iterations: ${data.iterations}\n`;
                    output += `Fuzz range: ±${data.fuzz_percentage}%\n\n`;
                    output += `✅ 50 variations transmitted!\n\n`;
                    output += `Check SDR++:\n`;
                    output += `• Did you see 50 bursts?\n`;
                    output += `• Were they slightly different?\n`;
                    output += `• Any device response?`;
                    showOutput(output);
                } else {
                    let errorMsg = data.message || 'Fuzzing failed';
                    let output = `❌ Error: ${errorMsg}\n\n`;

                    if (errorMsg.includes('timing data') || errorMsg.includes('raw IQ')) {
                        output += `ℹ️ Note:\n`;
                        output += `Advanced TX features work with\n`;
                        output += `CC1101 captures only.\n\n`;
                        output += `RTL-SDR captures (.cu8) are raw\n`;
                        output += `IQ samples and can't be fuzzed.\n\n`;
                        output += `To use Advanced TX:\n`;
                        output += `1. Use RF Tools (CC1101)\n`;
                        output += `2. Capture signal\n`;
                        output += `3. Signal will have timing data\n`;
                        output += `4. Then use Advanced TX features`;
                    }

                    showOutput(output);
                }
            } catch (error) {
                hideTXIndicator();
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function visualizeSignal(signalName) {
            showOutput(`📊 Visualizing "${signalName}"...\n\nGenerating waveform and analysis...`);

            try {
                // Get signal analysis
                const response = await fetch(`/api/analyze/${signalName}`);
                const data = await response.json();

                if (data.status === 'success') {
                    let output = `╔══════════════════════════════════════════╗\n`;
                    output += `║   📊 SIGNAL VISUALIZATION              ║\n`;
                    output += `╚══════════════════════════════════════════╝\n\n`;
                    output += `Signal: ${signalName}\n`;
                    output += `Frequency: ${(data.frequency / 1e6).toFixed(2)} MHz\n`;
                    output += `Sample Rate: ${(data.sample_rate / 1e6).toFixed(1)} MS/s\n\n`;

                    // Show decoded binary if available
                    if (data.decoded_binary) {
                        output += `═══ DECODED BINARY ═══\n`;
                        output += `${data.decoded_binary}\n\n`;
                        output += `Bits: ${data.decoded_binary.length}\n`;
                        output += `Hex: ${parseInt(data.decoded_binary, 2).toString(16).toUpperCase()}\n\n`;
                    }

                    // Show timing analysis
                    if (data.timings) {
                        output += `═══ TIMING ANALYSIS ═══\n`;
                        output += `Transitions: ${data.timings.length}\n`;
                        output += `Shortest: ${Math.min(...data.timings.map(t => t.duration_us))}μs\n`;
                        output += `Longest: ${Math.max(...data.timings.map(t => t.duration_us))}μs\n\n`;
                    }

                    // Show simple waveform visualization
                    if (data.waveform_ascii) {
                        output += `═══ WAVEFORM ═══\n`;
                        output += data.waveform_ascii + '\n\n';
                    }

                    output += `💡 TIP: Compare this with SDR++\n`;
                    output += `to verify accuracy!`;

                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Visualization failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // NFC GUARDIAN FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function guardianShowStatus() {
            showOutput('Loading Guardian status...');

            try {
                const response = await fetch('/api/guardian/status');
                const data = await response.json();

                let output = '╔═══════════════════════════════════════════╗\n';
                output += '║        🛡️  NFC GUARDIAN STATUS         ║\n';
                output += '╚═══════════════════════════════════════════╝\n\n';

                // Status
                if (data.monitoring) {
                    output += 'Status: 🟢 MONITORING\n';
                    output += `Since: ${new Date(data.stats.monitoring_since).toLocaleString()}\n\n`;
                } else {
                    output += 'Status: ⚫ STOPPED\n\n';
                }

                // Stats
                output += '═══ STATISTICS ═══\n';
                output += `Total scans: ${data.stats.total_scans}\n`;
                output += `Scans today: ${data.stats.scans_today}\n`;
                output += `Suspicious events: ${data.stats.suspicious_events}\n`;
                output += `Suspicious today: ${data.stats.suspicious_today}\n\n`;

                // Alert level
                output += '═══ ALERT LEVEL ═══\n';
                if (data.alert_level === 'normal') {
                    output += '● NORMAL - No threats detected\n';
                } else {
                    output += '⚠️  ELEVATED - Suspicious activity!\n';
                }

                // Last scan
                if (data.stats.last_scan) {
                    output += `\nLast scan: ${new Date(data.stats.last_scan).toLocaleString()}`;
                }

                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function guardianStart() {
            showOutput('Starting NFC Guardian monitoring...');

            try {
                const response = await fetch('/api/guardian/start', { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success' || data.status === 'info') {
                    let output = '✅ NFC Guardian ACTIVE\n\n';
                    output += '🛡️  Now monitoring for:\n';
                    output += '  • Rapid scan attempts\n';
                    output += '  • Multiple cards scanned quickly\n';
                    output += '  • Suspicious patterns\n\n';
                    output += '💡 Leave this running in your pocket\n';
                    output += '   to detect nearby NFC scanners!';
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + data.message);
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function guardianStop() {
            showOutput('Stopping NFC Guardian...');

            try {
                const response = await fetch('/api/guardian/stop', { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success') {
                    showOutput('⏹️ NFC Guardian STOPPED\n\nMonitoring paused.\nData saved to history.');
                } else {
                    showOutput('❌ Error: ' + data.message);
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function guardianShowSuspicious() {
            showOutput('Loading suspicious events...');

            try {
                const response = await fetch('/api/guardian/suspicious');
                const data = await response.json();

                if (data.events.length === 0) {
                    showOutput('✅ No suspicious activity detected!\n\nYour cards are safe.');
                    return;
                }

                let output = '╔═══════════════════════════════════════════╗\n';
                output += '║      ⚠️  SUSPICIOUS EVENTS LOG         ║\n';
                output += '╚═══════════════════════════════════════════╝\n\n';

                for (const event of data.events.slice(0, 10)) {
                    const date = new Date(event.timestamp);
                    output += `📅 ${date.toLocaleDateString()} ${date.toLocaleTimeString()}\n`;
                    output += `⚠️  ${event.reason}\n`;
                    output += `   Scans in window: ${event.recent_scan_count}\n`;
                    output += `   Trigger UID: ${event.trigger_uid}\n`;
                    output += '─'.repeat(45) + '\n';
                }

                output += `\nShowing ${Math.min(data.events.length, 10)} of ${data.events.length} events`;
                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // CARD CATALOG FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function catalogShowAll() {
            showOutput('Loading card catalog...');

            try {
                const response = await fetch('/api/catalog/cards');
                const data = await response.json();

                if (data.cards.length === 0) {
                    showOutput('📇 Card Catalog is empty\n\nAdd cards with "Add New Card"');
                    return;
                }

                let output = '╔═══════════════════════════════════════════╗\n';
                output += '║          📇 MY CARD CATALOG            ║\n';
                output += '╚═══════════════════════════════════════════╝\n\n';

                for (const card of data.cards) {
                    // Icon based on type
                    let icon = '💳';
                    if (card.type === 'badge') icon = '🎫';
                    else if (card.type === 'transit') icon = '🚇';
                    else if (card.type === 'access') icon = '🔑';

                    output += icon + ' ' + card.name;
                    if (card.protected) output += ' 🔒';
                    output += '\n';

                    output += `   Type: ${card.type}\n`;
                    output += `   UID: ${card.uid}\n`;

                    if (card.last_seen) {
                        const date = new Date(card.last_seen);
                        output += `   Last seen: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}\n`;
                    } else {
                        output += '   Last seen: Never\n';
                    }

                    output += `   Scans: ${card.scan_count || 0}\n`;

                    if (card.notes) {
                        output += `   Notes: ${card.notes}\n`;
                    }

                    output += '─'.repeat(45) + '\n';
                }

                output += `\nTotal cards: ${data.cards.length}`;
                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function catalogAddCard() {
            const name = prompt('Enter card name:', 'My Card');
            if (!name) return;

            const type = prompt('Card type (credit/debit/badge/transit/access/other):', 'credit');
            if (!type) return;

            showOutput(`📇 Adding card: ${name}\n\nPlease scan your card now...`);

            try {
                const response = await fetch('/api/catalog/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type, protected: false, notes: '' })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    let output = '✅ Card added to catalog!\n\n';
                    output += `Name: ${data.card.name}\n`;
                    output += `Type: ${data.card.type}\n`;
                    output += `UID: ${data.card.uid}\n`;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + data.message);
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function catalogIdentify() {
            showOutput('🔍 Scan your card to identify...\n\nHold card near reader...');

            try {
                const response = await fetch('/api/catalog/identify', { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success') {
                    if (data.registered) {
                        const card = data.card;
                        let output = '✅ Card identified!\n\n';
                        output += `Name: ${card.name}\n`;
                        output += `Type: ${card.type}\n`;
                        output += `UID: ${card.uid}\n`;

                        if (card.last_seen) {
                            output += `Last seen: ${new Date(card.last_seen).toLocaleDateString()}\n`;
                        }

                        output += `Total scans: ${card.scan_count || 0}\n`;

                        if (card.protected) {
                            output += '\n🔒 This card is marked as PROTECTED';
                        }

                        showOutput(output);
                    } else {
                        let output = '❓ Unknown card\n\n';
                        output += `UID: ${data.uid}\n\n`;
                        output += 'This card is not in your catalog.\n';
                        output += 'Use "Add New Card" to register it.';
                        showOutput(output);
                    }
                } else {
                    showOutput('❌ Error: ' + data.message);
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function catalogStats() {
            showOutput('Loading statistics...');

            try {
                const response = await fetch('/api/catalog/stats');
                const data = await response.json();

                let output = '╔═══════════════════════════════════════════╗\n';
                output += '║       📈 CATALOG STATISTICS            ║\n';
                output += '╚═══════════════════════════════════════════╝\n\n';

                output += `Total cards: ${data.total_cards}\n`;
                output += `Protected cards: ${data.protected_cards}\n\n`;

                if (Object.keys(data.types).length > 0) {
                    output += '═══ BY TYPE ═══\n';
                    for (const [type, count] of Object.entries(data.types)) {
                        output += `${type}: ${count}\n`;
                    }
                }

                if (data.most_recent) {
                    output += '\n═══ MOST RECENT ═══\n';
                    output += `${data.most_recent.name}\n`;
                    output += `Last seen: ${new Date(data.most_recent.last_seen).toLocaleDateString()}`;
                }

                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // WALLET TESTER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function walletQuickTest() {
            showOutput('🧪 Quick Wallet Test\n\nPlace card (in wallet) near reader...\n\nTesting for 3 seconds...');

            try {
                const response = await fetch('/api/wallet/quick_test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: 3 })
                });
                const data = await response.json();

                let output = '╔═══════════════════════════════════════════╗\n';
                output += '║       🧪 QUICK TEST RESULTS            ║\n';
                output += '╚═══════════════════════════════════════════╝\n\n';

                if (data.status === 'blocked') {
                    output += '✅ CARD IS BLOCKED\n\n';
                    output += '🛡️  Your wallet is working!\n\n';
                    output += `Attempts: ${data.attempts}\n`;
                    output += `Detections: ${data.detections}\n\n`;
                    output += data.recommendation;
                } else if (data.status === 'readable') {
                    output += '⚠️  CARD IS READABLE!\n\n';
                    output += '❌ Your wallet is NOT blocking RFID\n\n';
                    output += `Attempts: ${data.attempts}\n`;
                    output += `Detections: ${data.detections}\n\n`;
                    output += data.recommendation;
                } else {
                    output += '❌ Error: ' + data.message;
                }

                showOutput(output);
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        async function walletFullTest() {
            if (!confirm('Full test requires 2 steps:\n\n1. Test WITHOUT wallet (10 sec)\n2. Test WITH wallet (10 sec)\n\nContinue?')) {
                return;
            }

            showOutput('🔬 Full Wallet Effectiveness Test\n\n' +
                      'STEP 1: Baseline Test\n' +
                      'Hold card OUTSIDE wallet near reader...\n\n' +
                      'Testing for 10 seconds...');

            try {
                const response = await fetch('/api/wallet/full_test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: 10 })
                });
                const data = await response.json();

                if (data.status === 'complete') {
                    let output = '╔═══════════════════════════════════════════╗\n';
                    output += '║      🔬 FULL TEST RESULTS              ║\n';
                    output += '╚═══════════════════════════════════════════╝\n\n';

                    // Baseline
                    output += '═══ BASELINE (without wallet) ═══\n';
                    output += `Detections: ${data.baseline.detections}/${data.baseline.attempts}\n`;
                    output += `Success rate: ${data.baseline.success_rate.toFixed(1)}%\n\n`;

                    // Protected
                    output += '═══ PROTECTED (with wallet) ═══\n';
                    output += `Detections: ${data.protected.detections}/${data.protected.attempts}\n`;
                    output += `Success rate: ${data.protected.success_rate.toFixed(1)}%\n\n`;

                    // Effectiveness
                    output += '═══ BLOCKING EFFECTIVENESS ═══\n';
                    output += `${data.effectiveness.toFixed(1)}%\n\n`;

                    // Assessment
                    if (data.assessment === 'excellent') {
                        output += '🌟 EXCELLENT - Highly effective!\n';
                    } else if (data.assessment === 'good') {
                        output += '✅ GOOD - Working well\n';
                    } else if (data.assessment === 'fair') {
                        output += '⚠️  FAIR - Consider upgrading\n';
                    } else {
                        output += '❌ POOR - Upgrade recommended\n';
                    }

                    output += '\n' + data.recommendation;
                    showOutput(output);
                } else {
                    showOutput('❌ Error: ' + (data.message || 'Test failed'));
                }
            } catch (error) {
                showOutput('❌ Error: ' + error.message);
            }
        }

        // ============================================
        // SYSTEM POWER MANAGEMENT
        // ============================================

        async function systemShutdown() {
            if (!confirm('⚠️  SHUTDOWN SYSTEM?\n\nThis will safely power off the Raspberry Pi.\n\nYou will need to unplug and replug the power to turn it back on.\n\nContinue?')) {
                return;
            }

            showOutput('🔴 SHUTTING DOWN PIFLIP...\n\n' +
                      'System will power off in 5 seconds.\n\n' +
                      'Please wait for:\n' +
                      '• All LEDs to stop blinking\n' +
                      '• Green activity LED to turn off\n\n' +
                      'Then it\'s safe to unplug power.\n\n' +
                      'Goodbye! 👋');

            try {
                const response = await fetch('/api/system/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Connection will be lost, but that's expected
                    setTimeout(() => {
                        showOutput('🔴 System shutting down...\n\nConnection will be lost.\n\nWait 30 seconds before unplugging power.');
                    }, 2000);
                }
            } catch (error) {
                // Expected - connection lost during shutdown
                showOutput('🔴 Shutdown initiated.\n\nConnection lost (normal).\n\nWait for all LEDs to stop, then safe to unplug.');
            }
        }

        async function systemReboot() {
            if (!confirm('🔄 REBOOT SYSTEM?\n\nThis will restart the Raspberry Pi.\n\nYou will need to reconnect after ~60 seconds.\n\nContinue?')) {
                return;
            }

            showOutput('🔄 REBOOTING PIFLIP...\n\n' +
                      'System will restart in 5 seconds.\n\n' +
                      'Please wait ~60 seconds then:\n' +
                      '• Refresh this page\n' +
                      '• Reconnect to PiFlip\n\n' +
                      'Rebooting now...');

            try {
                const response = await fetch('/api/system/reboot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    setTimeout(() => {
                        showOutput('🔄 System rebooting...\n\nConnection will be lost.\n\nWait 60 seconds, then refresh page.');
                    }, 2000);
                }
            } catch (error) {
                // Expected - connection lost during reboot
                showOutput('🔄 Reboot initiated.\n\nConnection lost (normal).\n\nWait 60 seconds, then refresh page.');
            }
        }

    </script>
</body>
</html>
